<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Gamma Tech ‚Äî Residential Technology Budget Planner</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #0F2F44;
  --primary-light: #133F5C;
  --accent: #017ED7;
  --accent-hover: #0069AF;
  --accent-bg: #EEF8FE;
  --good: #2E7D32;
  --good-bg: #E8F5E9;
  --good-border: #A5D6A7;
  --better: #0692EF;
  --better-bg: #EEF8FE;
  --better-border: #74C7FF;
  --standard: #1976D2;
  --standard-bg: #E3F2FD;
  --standard-border: #64B5F6;
  --best: #0069AF;
  --best-bg: #E8F1F8;
  --best-border: #133F5C;
  --none-bg: #F5F5F5;
  --text: #393939;
  --text-light: #5A5A5A;
  --text-lighter: #B2B2B2;
  --bg: #FAFAFA;
  --card: #FFFFFF;
  --border: #E0E0E0;
  --shadow: 0 2px 16px rgba(15,47,68,0.06);
  --shadow-lg: 0 8px 32px rgba(15,47,68,0.10);
  --radius: 16px;
  --radius-sm: 10px;
  --transition: all 0.25s ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

/* TOAST */
.toast {
  position: fixed;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--primary);
  color: white;
  padding: 14px 28px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* SHARED CONFIG BANNER */
.shared-banner {
  background: linear-gradient(135deg, #E8F5E9 0%, #EEF8FE 100%);
  border: 2px solid var(--good-border);
  border-radius: var(--radius);
  padding: 20px 24px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}
.shared-banner .shared-text {
  font-size: 15px;
  color: var(--text);
  font-weight: 500;
}
.shared-banner .shared-text small {
  display: block;
  font-size: 12px;
  color: var(--text-light);
  font-weight: 400;
  margin-top: 4px;
}
.shared-banner .btn-save {
  background: var(--accent);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  white-space: nowrap;
}
.shared-banner .btn-save:hover {
  background: var(--accent-hover);
}

body {
  font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  padding-bottom: 100px;
}

/* HEADER */
header {
  background: linear-gradient(135deg, #0F2F44 0%, #133F5C 100%);
  color: white;
  padding: 28px 32px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 24px rgba(15,47,68,0.18);
}
header .header-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
}
header .brand {
  display: flex;
  align-items: center;
  gap: 16px;
}
header .brand .logo-img {
  height: 40px;
  width: auto;
}
header .brand .logo-img svg {
  height: 40px;
  width: auto;
}
header .brand .logo-text {
  font-family: 'Poppins', sans-serif;
  font-size: 26px;
  font-weight: 800;
  letter-spacing: 2px;
  color: #FFFFFF;
}
header .brand .logo-text span {
  color: #74C7FF;
}
header .subtitle {
  font-size: 14px;
  opacity: 0.75;
  font-weight: 400;
  letter-spacing: 0.3px;
}
header .total-display {
  text-align: right;
}
header .total-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0.6;
  font-weight: 500;
}
header .total-amount {
  font-size: 34px;
  font-weight: 800;
  color: #74C7FF;
  font-variant-numeric: tabular-nums;
  letter-spacing: -1px;
}

/* MAIN */
main {
  max-width: 1200px;
  margin: 0 auto;
  padding: 28px 16px;
}

/* PROJECT DETAILS */
.project-details {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 32px;
  margin-bottom: 24px;
}
.project-details h2 {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 22px;
  color: var(--text);
  letter-spacing: -1px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 18px;
}
.form-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.form-group input, .form-group select {
  width: 100%;
  padding: 11px 14px;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 15px;
  font-family: 'Poppins', sans-serif;
  color: var(--text);
  transition: var(--transition);
  background: white;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(1,126,215,0.12);
}

/* PRESETS */
.presets {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 28px 32px;
  margin-bottom: 24px;
}
.presets h2 {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 18px;
  color: var(--text);
  letter-spacing: -1px;
}
.preset-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}
.preset-btn {
  padding: 18px;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  background: white;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
}
.preset-btn:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}
.preset-btn.active {
  border-color: var(--accent);
  background: var(--accent-bg);
}
.preset-btn .preset-name {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 4px;
  color: var(--text);
}
.preset-btn .preset-range {
  font-size: 13px;
  color: var(--text-light);
}
.preset-btn .preset-desc {
  font-size: 12px;
  color: var(--text-lighter);
  margin-top: 4px;
}

/* CATEGORIES */
.categories-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 36px 0 18px;
  padding: 0 4px;
}
.categories-header h2 {
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -1px;
}
.category-count {
  font-size: 14px;
  color: var(--text-light);
  font-weight: 500;
}

.section-header {
  margin: 32px 0 16px;
  padding: 0 4px;
}
.section-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary);
  letter-spacing: -0.5px;
  text-transform: uppercase;
  border-bottom: 2px solid var(--accent);
  padding-bottom: 8px;
  display: inline-block;
}

.category-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 16px;
  overflow: hidden;
  transition: var(--transition);
  border: 2px solid transparent;
}
.category-card.has-selection {
  border-color: var(--border);
}
.category-card.tier-good { border-color: var(--good-border); }
.category-card.tier-standard { border-color: var(--standard-border); }
.category-card.tier-better { border-color: var(--better-border); }
.category-card.tier-best { border-color: var(--best-border); }
.category-card.disabled {
  opacity: 0.5;
  pointer-events: none;
  background: var(--none-bg);
}
.category-card.disabled .category-price {
  color: var(--text-lighter);
}

.category-header {
  padding: 22px 26px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  user-select: none;
}
.category-icon {
  font-size: 28px;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--accent-bg);
  border-radius: var(--radius-sm);
  flex-shrink: 0;
}
.category-info { flex: 1; }
.category-name {
  font-size: 17px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.5px;
}
.category-desc {
  font-size: 13px;
  color: var(--text-light);
  margin-top: 2px;
}
.category-price {
  font-size: 20px;
  font-weight: 800;
  color: var(--accent);
  text-align: right;
  min-width: 100px;
  font-variant-numeric: tabular-nums;
  letter-spacing: -0.5px;
}
.category-price.no-selection {
  color: var(--text-lighter);
  font-size: 14px;
  font-weight: 500;
}

.category-body {
  padding: 0 26px 26px;
  display: none;
}
.category-card.open .category-body {
  display: block;
}

.tier-selector {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  margin-bottom: 16px;
}
@media (max-width: 768px) {
  .tier-selector {
    grid-template-columns: repeat(2, 1fr);
  }
}

.tier-btn {
  padding: 16px 12px;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  background: white;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
}
.tier-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
.tier-btn .tier-label {
  font-weight: 700;
  font-size: 14px;
  margin-bottom: 2px;
}
.tier-btn .tier-price {
  font-size: 18px;
  font-weight: 800;
  margin: 4px 0;
  font-variant-numeric: tabular-nums;
}
.tier-btn .tier-tag {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

.tier-btn.none-btn { border-color: var(--border); }
.tier-btn.none-btn.selected { background: var(--none-bg); border-color: #bbb; }
.tier-btn.none-btn .tier-label { color: var(--text-lighter); }

.tier-btn.good-btn .tier-label, .tier-btn.good-btn .tier-price { color: var(--good); }
.tier-btn.good-btn.selected { background: var(--good-bg); border-color: var(--good); }

.tier-btn.standard-btn .tier-label, .tier-btn.standard-btn .tier-price { color: var(--standard); }
.tier-btn.standard-btn.selected { background: var(--standard-bg); border-color: var(--standard); }

.tier-btn.better-btn .tier-label, .tier-btn.better-btn .tier-price { color: var(--better); }
.tier-btn.better-btn.selected { background: var(--better-bg); border-color: var(--better); }

.tier-btn.best-btn .tier-label, .tier-btn.best-btn .tier-price { color: var(--best); }
.tier-btn.best-btn.selected { background: var(--best-bg); border-color: var(--best); }

.tier-btn.tier-disabled {
  opacity: 0.4;
  cursor: not-allowed;
  pointer-events: none;
}
.tier-btn.tier-disabled .tier-label,
.tier-btn.tier-disabled .tier-price,
.tier-btn.tier-disabled .tier-tag {
  color: var(--text-lighter) !important;
}

.tier-details {
  background: var(--accent-bg);
  border-radius: var(--radius-sm);
  padding: 18px 22px;
}
.tier-details h4 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--text);
  letter-spacing: -0.5px;
}
.tier-details ul {
  list-style: none;
  padding: 0;
}
.tier-details ul li {
  font-size: 13px;
  color: var(--text-light);
  padding: 3px 0;
  padding-left: 22px;
  position: relative;
}
.tier-details ul li::before {
  content: '‚úì';
  position: absolute;
  left: 0;
  color: var(--accent);
  font-weight: 700;
}
.tier-details .brands {
  font-size: 12px;
  color: var(--text-lighter);
  margin-top: 10px;
  font-style: italic;
}

/* EXTRAS */
.extras-section {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 28px 32px;
  margin-top: 24px;
}
.extras-section h2 {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 18px;
  color: var(--text);
  letter-spacing: -1px;
}
.extras-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}
.extra-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}
.extra-item:hover { border-color: var(--accent); }
.extra-item.active { border-color: var(--accent); background: var(--accent-bg); }
.extra-item .extra-info { display: flex; align-items: center; gap: 10px; }
.extra-item .extra-name { font-weight: 600; font-size: 14px; color: var(--text); }
.extra-item .extra-note { font-size: 12px; color: var(--text-lighter); }
.extra-item .extra-price { font-weight: 700; color: var(--accent); }
.extra-toggle {
  width: 44px; height: 24px;
  background: #D0D0D0;
  border-radius: 12px;
  position: relative;
  transition: var(--transition);
  flex-shrink: 0;
}
.extra-item.active .extra-toggle { background: var(--accent); }
.extra-toggle::after {
  content: '';
  width: 20px; height: 20px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 2px; left: 2px;
  transition: var(--transition);
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}
.extra-item.active .extra-toggle::after { left: 22px; }

/* PM SLIDER */
.pm-section {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 28px 32px;
  margin-top: 16px;
}
.pm-row {
  display: flex;
  align-items: center;
  gap: 16px;
}
.pm-row label { font-weight: 600; font-size: 14px; min-width: 200px; color: var(--text); }
.pm-row input[type=range] { flex: 1; accent-color: var(--accent); }
.pm-row .pm-value { font-weight: 700; color: var(--accent); font-size: 18px; min-width: 80px; text-align: right; }

/* SUMMARY BAR */
.summary-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--primary);
  color: white;
  padding: 16px 32px;
  z-index: 100;
  box-shadow: 0 -4px 24px rgba(15,47,68,0.18);
}
.summary-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}
.summary-stats {
  display: flex;
  gap: 24px;
  font-size: 13px;
}
.summary-stats .stat-label { opacity: 0.6; }
.summary-stats .stat-value { font-weight: 700; }
.summary-actions { display: flex; gap: 12px; }
.btn {
  padding: 10px 24px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 700;
  font-family: 'Poppins', sans-serif;
  cursor: pointer;
  transition: var(--transition);
}
.btn-primary {
  background: var(--accent);
  color: white;
}
.btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
.btn-outline {
  background: transparent;
  color: white;
  border: 2px solid rgba(255,255,255,0.25);
}
.btn-outline:hover { border-color: white; }

/* SUMMARY MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15,47,68,0.45);
  z-index: 200;
  overflow-y: auto;
  padding: 40px 20px;
  backdrop-filter: blur(4px);
}
.modal-overlay.active { display: flex; justify-content: center; align-items: flex-start; }
.modal {
  background: white;
  border-radius: 20px;
  max-width: 800px;
  width: 100%;
  box-shadow: var(--shadow-lg);
  position: relative;
}
.modal-header {
  padding: 28px 32px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-header h2 { font-size: 22px; font-weight: 700; color: var(--text); letter-spacing: -1px; }
.modal-close {
  width: 38px; height: 38px;
  border: none;
  background: var(--bg);
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-light);
  transition: var(--transition);
}
.modal-close:hover { background: var(--border); }
.modal-body { padding: 28px 32px; }
.modal-footer {
  padding: 20px 32px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.summary-table { width: 100%; border-collapse: collapse; margin: 16px 0; }
.summary-table th, .summary-table td { padding: 10px 12px; text-align: left; font-size: 14px; }
.summary-table th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-lighter); font-weight: 600; border-bottom: 2px solid var(--border); }
.summary-table td { border-bottom: 1px solid #f0f0f0; }
.summary-table .tier-badge {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.summary-table .tier-badge.good { background: var(--good-bg); color: var(--good); }
.summary-table .tier-badge.standard { background: var(--standard-bg); color: var(--standard); }
.summary-table .tier-badge.better { background: var(--better-bg); color: var(--better); }
.summary-table .tier-badge.best { background: var(--best-bg); color: var(--best); }
.summary-table .price-cell { text-align: right; font-weight: 700; font-variant-numeric: tabular-nums; }
.summary-table tfoot td { border-top: 2px solid var(--primary); font-weight: 800; font-size: 16px; }
.summary-table tfoot .grand-total { color: var(--accent); font-size: 22px; }

.summary-project-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 22px;
  font-size: 14px;
}
.summary-project-info .info-label { color: var(--text-light); font-weight: 500; }
.summary-project-info .info-value { font-weight: 600; color: var(--text); }

.disclaimer {
  font-size: 11px;
  color: var(--text-lighter);
  margin-top: 24px;
  padding-top: 18px;
  border-top: 1px solid var(--border);
  line-height: 1.7;
}
.disclaimer strong {
  color: var(--text-light);
}

/* PRINT STYLES */
@media print {
  header, main, .summary-bar, .toast, #sharedBanner, .modal-close, .modal-footer, .presets, .no-print { display: none !important; }
  .modal-overlay { position: static; background: none; padding: 0; display: block !important; backdrop-filter: none; }
  .modal { box-shadow: none; max-width: none; border-radius: 0; }
  body { background: white; padding: 0; }
  .summary-table th, .summary-table td { padding: 6px 8px; }
  .features-row { page-break-inside: avoid; }
  .features-row td { border-top: none !important; }
  .summary-project-info .info-label { color: #555 !important; }
  .summary-project-info .info-value { color: #111 !important; }
  .disclaimer { color: #333 !important; }
  .tier-badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}

/* RESPONSIVE */
@media (max-width: 600px) {
  body { padding-bottom: 140px; }
  header { padding: 14px 16px; }
  header .header-inner {
    flex-wrap: nowrap;
    align-items: center;
    gap: 8px;
  }
  header .brand { flex: 1; min-width: 0; }
  header .brand .logo-img { height: 24px; }
  header .brand .logo-img svg { height: 24px; }
  header .subtitle { font-size: 10px; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  header .total-display { text-align: right; flex-shrink: 0; }
  header .total-label { font-size: 9px; letter-spacing: 0.5px; }
  header .total-amount { font-size: 20px; }
  .project-details, .presets, .extras-section, .pm-section { padding: 22px 18px; }
  .category-header { padding: 16px 18px; }
  .category-body { padding: 0 18px 18px; }
  .form-grid { grid-template-columns: 1fr; }
  .summary-bar { 
    padding: 12px 16px; 
    padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
  }
  .summary-inner { flex-direction: column; text-align: center; gap: 10px; }
  .summary-stats { flex-wrap: wrap; justify-content: center; gap: 16px; }
  .summary-actions { 
    width: 100%; 
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 8px; 
  }
  .summary-actions .btn { 
    padding: 10px 8px; 
    font-size: 11px; 
    white-space: nowrap;
  }
  .pm-row { flex-direction: column; align-items: flex-start; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div>
        <div class="logo-img"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1107 250" height="40"><defs><style>.hdr-1{fill:#fff;}.hdr-2{fill:#ffffff;}.hdr-3{fill:#74C7FF;}</style></defs><g><path class="hdr-2" d="M320.009,99.228v-28.137c0-4.98-.999-8.466-3.498-11.454-1.249-1.245-3.248-1.992-5.497-1.992-4.747,0-6.996,3.486-7.995,6.723-.75,1.992-.999,4.233-.999,6.723v110.059c0,5.229,1.249,8.715,3.748,11.454,1.249,1.245,2.998,1.992,5.247,1.992,4.747,0,6.996-2.988,7.995-6.723,.75-1.743,.999-3.984,.999-6.723v-33.117h-10.743v-22.659h37.726v91.134h-15.99l-3.248-8.715c-4.997,6.225-12.242,10.707-20.987,10.707s-14.741-2.241-19.238-6.225c-4.497-3.735-7.495-8.466-9.494-13.446-2.249-5.727-3.248-12.45-2.998-19.92V71.091c.25-7.221,1.749-13.944,4.497-19.671,2.249-4.98,5.497-9.96,10.493-13.695,4.997-3.735,11.992-6.225,20.987-6.225s15.74,2.49,20.737,6.225,8.495,8.715,10.743,13.695c2.748,5.727,4.247,12.45,4.497,19.671v28.137h-26.983Z"/><path class="hdr-2" d="M359.23,216.508l27.733-183.016h32.979l27.733,183.016h-26.233l-4.997-37.35h-25.984l-4.997,37.35h-26.233Zm45.721-123.505l-.75-4.731h-1.499l-.75,4.731-7.745,57.768h18.488l-7.745-57.768Z"/><path class="hdr-2" d="M504.887,216.508l-17.239-115.039-.999-7.719h-1.499v122.758h-24.984V33.492h32.979l15.99,83.664,1.249,9.711h.5l1.249-9.711,15.99-83.664h32.979V216.508h-24.984V93.75h-1.499l-.999,7.719-17.239,115.039h-11.493Z"/><path class="hdr-2" d="M625.809,216.508l-17.239-115.039-.999-7.719h-1.499v122.758h-24.984V33.492h32.979l15.99,83.664,1.249,9.711h.5l1.249-9.711,15.99-83.664h32.979V216.508h-24.984V93.75h-1.499l-.999,7.719-17.239,115.039h-11.493Z"/><path class="hdr-2" d="M694.514,216.508l27.733-183.016h32.979l27.733,183.016h-26.233l-4.997-37.35h-25.984l-4.997,37.35h-26.233Zm45.721-123.505l-.75-4.731h-1.499l-.75,4.731-7.745,57.768h18.488l-7.745-57.768Z"/><path class="hdr-3" d="M780.461,61.131v-27.639h77.951v27.639h-25.484V216.508h-26.983V61.131h-25.484Z"/><path class="hdr-3" d="M868.904,33.492h61.711v27.639h-34.728v48.057h24.984v29.382h-24.984v50.298h34.728v27.639h-61.711V33.492Z"/><path class="hdr-3" d="M1015.809,153.76v25.149c-.25,7.47-1.749,14.193-4.497,19.92-2.249,4.98-5.746,9.711-10.743,13.446-4.997,3.984-11.743,6.225-20.737,6.225s-15.99-2.241-20.987-6.225c-4.997-3.735-8.245-8.466-10.493-13.446-2.748-5.727-4.247-12.45-4.497-19.92V71.091c.25-7.221,1.749-13.944,4.497-19.671,2.249-4.98,5.497-9.96,10.493-13.695s11.992-6.225,20.987-6.225,15.74,2.49,20.737,6.225,8.495,8.715,10.743,13.695c2.748,5.727,4.247,12.45,4.497,19.671v25.149h-25.234v-25.149c0-4.98-1.249-8.466-3.997-11.454-1.249-1.245-3.498-1.992-6.246-1.992-4.747,0-6.996,3.486-8.245,6.723-.75,1.992-.999,4.233-1.249,6.723v107.818c.25,5.229,1.749,8.715,4.247,11.454,1.249,1.245,2.998,1.992,5.247,1.992,5.746,0,7.995-2.988,9.244-6.723,.75-1.743,.999-3.984,.999-6.723v-25.149h25.234Z"/><path class="hdr-3" d="M1080.017,136.828h-20.987v79.68h-26.983V33.492h26.983V109.188h20.987V33.492h26.983V216.508h-26.983v-79.68Z"/></g><g><path class="hdr-3" d="M250,125c0,68.361-54.876,123.904-122.98,124.982v-16.333c59.086-1.076,106.649-49.306,106.649-108.649h-96.874v-16.414h95.641c-7.813-51.581-51.886-91.26-105.417-92.235V.018c68.104,1.078,122.98,56.621,122.98,124.982Z"/><path class="hdr-2" d="M136.795,108.586h79.01c-1.194-6.679-3.131-13.194-5.793-19.49-4.646-10.985-11.301-20.854-19.778-29.331-8.477-8.477-18.346-15.131-29.331-19.778-6.295-2.662-12.811-4.599-19.49-5.793-4.722-.848-9.528-1.326-14.394-1.427-.672-.015-1.346-.023-2.02-.023s-1.349,.008-2.02,.023c-4.866,.101-9.672,.578-14.394,1.427-6.679,1.194-13.194,3.131-19.49,5.793-10.985,4.646-20.854,11.301-29.331,19.778-8.477,8.477-15.131,18.346-19.778,29.331-4.806,11.361-7.242,23.442-7.242,35.904s2.437,24.543,7.242,35.904c4.646,10.985,11.301,20.854,19.778,29.331,8.477,8.477,18.346,15.131,29.331,19.778,6.295,2.662,12.811,4.599,19.49,5.793,4.722,.848,9.528,1.326,14.394,1.427,.672,.015,1.346,.023,2.02,.023s1.349-.008,2.02-.023c4.866-.101,9.672-.578,14.394-1.427,6.679-1.194,13.194-3.131,19.49-5.793,10.985-4.646,20.854-11.301,29.331-19.778,8.477-8.477,15.131-18.346,19.778-29.331,2.662-6.295,4.598-12.811,5.793-19.49h-79.01v-32.828Zm-13.816-92.235V.018C54.876,1.096,0,56.639,0,125s54.876,123.904,122.98,124.982v-16.333c-59.086-1.076-106.649-49.306-106.649-108.649S63.894,17.427,122.98,16.351Z"/><path class="hdr-1" d="M233.669,125c0,59.343-47.563,107.573-106.649,108.649v16.333l-2.02,.018-2.02-.018v-16.333c-59.086-1.076-106.649-49.306-106.649-108.649S63.894,17.427,122.98,16.351V.018c.672-.013,1.346-.018,2.02-.018s1.349,.005,2.02,.018V16.351c53.53,.975,97.604,40.654,105.417,92.235h-16.631c-1.194-6.679-3.131-13.194-5.793-19.49-4.646-10.985-11.301-20.854-19.778-29.331-8.477-8.477-18.346-15.131-29.331-19.778-6.295-2.662-12.811-4.599-19.49-5.793-4.722-.848-9.528-1.326-14.394-1.427-.672-.015-1.346-.023-2.02-.023s-1.349,.008-2.02,.023c-4.866,.101-9.672,.578-14.394,1.427-6.679,1.194-13.194,3.131-19.49,5.793-10.985,4.646-20.854,11.301-29.331,19.778-8.477,8.477-15.131,18.346-19.778,29.331-4.806,11.361-7.242,23.442-7.242,35.904s2.437,24.543,7.242,35.904c4.646,10.985,11.301,20.854,19.778,29.331,8.477,8.477,18.346,15.131,29.331,19.778,6.295,2.662,12.811,4.599,19.49,5.793,4.722,.848,9.528,1.326,14.394,1.427,.672,.015,1.346,.023,2.02,.023s1.349-.008,2.02-.023c4.866-.101,9.672-.578,14.394-1.427,6.679-1.194,13.194-3.131,19.49-5.793,10.985-4.646,20.854-11.301,29.331-19.778,8.477-8.477,15.131-18.346,19.778-29.331,2.662-6.295,4.598-12.811,5.793-19.49h-79.01v-16.414h96.874Z"/></g></svg></div>
        <div class="subtitle">Residential Technology Budget Planner</div>
      </div>
    </div>
    <div class="total-display">
      <div class="total-label">Estimated Investment</div>
      <div class="total-amount" id="headerTotal">$0</div>
    </div>
  </div>
</header>

<div class="toast" id="toast"></div>
<div id="sharedBanner"></div>

<main>
  <!-- PROJECT DETAILS -->
  <div class="project-details">
    <h2>üìã Project Details</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>Client / Project Name</label>
        <input type="text" id="clientName" placeholder="e.g. Smith Residence">
      </div>
      <div class="form-group">
        <label>Builder</label>
        <input type="text" id="builder" placeholder="">
      </div>
      <div class="form-group">
        <label>Home Size (sq ft)</label>
        <input type="number" id="homeSize" value="4000" min="1500" max="35000" step="100" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Property Type</label>
        <select id="propertyType" autocomplete="off">
          <option value="residential">Single Family</option>
          <option value="condo">Condo</option>
        </select>
      </div>
    </div>
  </div>

  <!-- QUICK PRESETS -->
  <!-- CATEGORIES -->
  <div class="categories-header">
    <h2>System Categories</h2>
    <div class="category-count" id="categoryCount">0 of 17 selected</div>
  </div>
  <div id="categoriesContainer"></div>

  <!-- EXTRAS -->
  <div class="extras-section" id="extrasSection">
    <h2>üìé Additional Items</h2>
    <div class="extras-grid" id="extrasGrid"></div>
  </div>

  <!-- CUSTOM MODIFIERS -->
  <div class="extras-section">
    <h2>üîß Custom Adjustments</h2>
    <p style="font-size:13px;color:var(--text-lighter);margin-bottom:12px;">Add or subtract line items for anything outside the standard categories.</p>
    <div id="modifiersContainer"></div>
    <button class="btn btn-outline" onclick="addModifier()" style="margin-top:10px;width:100%;padding:14px;font-size:15px;border:2px dashed var(--border);border-radius:var(--radius);color:var(--accent);font-weight:600;">+ Add Line Item</button>
  </div>
</main>

<!-- SUMMARY BAR -->
<div class="summary-bar">
  <div class="summary-inner">
    <div class="summary-stats">
      <div><span class="stat-label">Subtotal: </span><span class="stat-value" id="statSubtotal">$0</span></div>
      <div><span class="stat-label">Tax Est: </span><span class="stat-value" id="statTax">$0</span></div>
    </div>
    <div class="summary-actions">
      <button class="btn btn-outline" onclick="expandAll()">Expand All</button>
      <button class="btn btn-outline" onclick="shareLink()">üîó Share Link</button>
      <button class="btn btn-outline" onclick="showEmailModal()">üìß Email</button>
      <button class="btn btn-primary" onclick="showSummary()">üìÑ View Summary</button>
    </div>
  </div>
</div>

<!-- SUMMARY MODAL -->
<div class="modal-overlay" id="summaryModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Budget Summary</h2>
      <button class="modal-close" onclick="closeSummary()">‚úï</button>
    </div>
    <div class="modal-body" id="summaryBody"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" style="color:var(--text);border-color:var(--border);" onclick="closeSummary()">Close</button>
      <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
    </div>
  </div>
</div>

<!-- EMAIL MODAL -->
<div class="modal-overlay" id="emailModal">
  <div class="modal" style="max-width: 480px;">
    <div class="modal-header">
      <h2>üìß Email Budget</h2>
      <button class="modal-close" onclick="closeEmailModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 20px; color: var(--text-light); font-size: 14px;">
        Send this budget directly to the client's email.
      </p>
      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text);">Recipient Name</label>
        <input type="text" id="emailRecipientName" placeholder="e.g., John Smith" 
          style="width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 15px;">
      </div>
      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text);">Recipient Email <span style="color: #E53935;">*</span></label>
        <input type="email" id="emailRecipientEmail" placeholder="client@email.com" required
          style="width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 15px;">
      </div>
      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text);">Subject</label>
        <input type="text" id="emailSubject" placeholder="Your Technology Budget from Gamma Tech"
          style="width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 15px;">
      </div>
      <div id="emailStatus" style="display: none; padding: 12px 16px; border-radius: var(--radius-sm); margin-top: 16px; font-size: 14px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" style="color:var(--text);border-color:var(--border);" onclick="closeEmailModal()">Cancel</button>
      <button class="btn btn-primary" id="emailSendBtn" onclick="sendProposalEmail()">üìß Send Email</button>
    </div>
  </div>
</div>

<script src="categories-data.js"></script>
<script>
// ============================================================
// BASE PATH DETECTION (for reverse proxy / Tailscale serve)
// ============================================================
const BASE_PATH = (() => {
  // Detect if we're behind a path prefix (e.g., /budget-dev)
  const path = window.location.pathname;
  // Remove trailing /budget or /b/ if present
  const match = path.match(/^(\/[^\/]+)/);
  if (match && match[1] !== '/budget' && match[1] !== '/b' && !path.startsWith('/api')) {
    return match[1];
  }
  return '';
})();

function api(endpoint) {
  return BASE_PATH + endpoint;
}

// ============================================================
// DATA ‚Äî Based on real Gamma Tech projects + industry research
// Prices calibrated to 4,000 sq ft new construction baseline
// ============================================================
// DATA CONFIGS ‚Äî one per property type
// To edit condo data: search for "CONDO DATA" below
// To edit residential data: search for "RESIDENTIAL DATA" below
// ============================================================

// ---- RESIDENTIAL DATA ----
// Category data loaded from external file (categories-data.js)

// Customization state - must be declared before CATEGORIES() is called
let isCustomizedBudget = false;
let customCategoryConfig = null;
let customCategories = null;
let sqftLocked = null;
let propertyTypeLocked = null;

// Active data accessors ‚Äî everything uses these
function CATEGORIES() {
  const base = CONFIGS[state.propertyType].categories;
  
  // If not customized, return defaults
  if (!isCustomizedBudget || !customCategoryConfig) {
    return base;
  }
  
  // Apply custom config
  const result = [];
  
  // Process default categories with overrides
  base.forEach(cat => {
    const override = customCategoryConfig[cat.id];
    
    // Skip hidden categories
    if (override && override.hidden === true) {
      return;
    }
    
    // Clone the category
    const customCat = JSON.parse(JSON.stringify(cat));
    
    // Apply tier overrides
    if (override && override.tiers) {
      Object.keys(override.tiers).forEach(tierKey => {
        const tierOverride = override.tiers[tierKey];
        
        // Skip disabled tiers
        if (tierOverride.enabled === false) {
          delete customCat.tiers[tierKey];
          return;
        }
        
        // Apply overrides
        if (customCat.tiers[tierKey]) {
          if (tierOverride.price !== undefined) customCat.tiers[tierKey].price = tierOverride.price;
          if (tierOverride.label) customCat.tiers[tierKey].label = tierOverride.label;
          if (tierOverride.features) customCat.tiers[tierKey].features = tierOverride.features;
          if (tierOverride.brands) customCat.tiers[tierKey].brands = tierOverride.brands;
        }
      });
    }
    
    // Mark as customized (disables size scaling)
    customCat.isCustomized = true;
    
    result.push(customCat);
  });
  
  // Add custom categories
  if (customCategories && customCategories.length > 0) {
    customCategories.forEach(cc => {
      // Build tiers object
      const tiers = {};
      if (cc.tiers) {
        Object.keys(cc.tiers).forEach(tierKey => {
          const t = cc.tiers[tierKey];
          if (t.enabled !== false) {
            tiers[tierKey] = {
              price: t.price || 0,
              label: t.label || tierKey,
              features: t.features || [],
              brands: t.brands || ''
            };
          }
        });
      }
      
      result.push({
        id: cc.id,
        section: 'Custom',
        name: cc.name,
        icon: cc.icon || 'üì¶',
        desc: cc.desc || '',
        sizeScale: 0, // No scaling for custom
        isCustomized: true,
        tiers
      });
    });
  }
  
  return result;
}

function EXTRAS() { return CONFIGS[state.propertyType].extras; }

// ============================================================
// APP STATE
// ============================================================
let state = {
  selections: {},  // { categoryId: 'good'|'better'|'best'|null }
  extras: {},      // { extraId: true|false }
  modifiers: [],   // { id, name, amount } ‚Äî positive or negative
  catMods: {},     // { categoryId: { name, amount } } ‚Äî per-category adjustments
  homeSize: 4000,
  propertyType: 'residential'
};

// Initialize state for all property types (so switching doesn't lose data)
function initStateForConfig() {
  CATEGORIES().forEach(c => {
    if (!(c.id in state.selections)) state.selections[c.id] = null;
    if (!(c.id in state.catMods)) state.catMods[c.id] = { name: '', amount: 0 };
  });
  EXTRAS().forEach(e => {
    if (!(e.id in state.extras)) state.extras[e.id] = e.default;
  });
}
initStateForConfig();

// ============================================================
// SIZE SCALING
// ============================================================
function getSizeMultiplier(sqft, scaleFactor) {
  // Baseline: 4000 sq ft = 1.0
  // Minimum: 2500 sq ft (smaller homes use 2500 for calculations)
  // Scale factor determines how much this category responds to size changes
  if (scaleFactor === 0) return 1; // theater doesn't scale
  const effectiveSqft = Math.max(sqft, 2500); // enforce 2500 minimum
  const baseline = 4000;
  const ratio = effectiveSqft / baseline;
  // Dampen the scaling: use scaleFactor to blend between 1.0 and the ratio
  return 1 + (ratio - 1) * scaleFactor;
}

function getCategoryPrice(cat, tier) {
  if (!tier) return 0;
  const tierData = cat.tiers[tier];
  if (!tierData) return 0;
  const base = tierData.price;
  
  // If category is customized, use fixed price (no scaling)
  if (cat.isCustomized) {
    return base;
  }
  
  // Skip size scaling for base tier if category opts out
  const skipSize = cat.baseTierNoScale && tier === 'good';
  // Use tier-level sizeScale if defined, otherwise fall back to category sizeScale
  const scaleToUse = tierData.sizeScale !== undefined ? tierData.sizeScale : cat.sizeScale;
  const sizeMult = skipSize ? 1 : getSizeMultiplier(state.homeSize, scaleToUse);
  return Math.round(base * sizeMult / 100) * 100; // round to nearest $100
}

// ============================================================
// RENDERING
// ============================================================
const SECTION_ORDER = ['Infrastructure', 'Audio', 'Video', 'Control & Automation', 'Lighting & Shades', 'Security', 'Custom'];

function renderCategories() {
  const categories = CATEGORIES();
  if (categories.length > 0) {
  }
  
  const container = document.getElementById('categoriesContainer');
  container.innerHTML = '';
  
  // Group categories by section
  const sections = {};
  CATEGORIES().forEach(cat => {
    const section = cat.section || 'Other';
    if (!sections[section]) sections[section] = [];
    sections[section].push(cat);
  });
  
  // Render in defined order
  SECTION_ORDER.forEach(sectionName => {
    const cats = sections[sectionName];
    if (!cats || cats.length === 0) return;
    
    // Add section header
    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = `<h3>${sectionName}</h3>`;
    container.appendChild(header);
    
    // Render categories in this section
    cats.forEach(cat => {
      const selected = state.selections[cat.id];
      const basePrice = getCategoryPrice(cat, selected);
      const catModAmount = state.catMods[cat.id]?.amount || 0;
      const price = basePrice + catModAmount;
      const tierClass = selected ? 'tier-' + selected : '';
      
      // Check mutual exclusivity for lighting
      let isDisabled = false;
      if (cat.id === 'lighting' && state.selections['lighting-centralized']) {
        isDisabled = true;
      } else if (cat.id === 'lighting-centralized' && state.selections['lighting']) {
        isDisabled = true;
      }
      // Designer Keypads requires a lighting control selection first, and not compatible with Wireless Basic
      if (cat.id === 'lighting-designer' && (!state.selections['lighting'] && !state.selections['lighting-centralized'] || state.selections['lighting'] === 'good')) {
        isDisabled = true;
      }
      // Invisible Speakers requires Multi-Room Audio selection first
      if (cat.id === 'invisible-speakers' && !state.selections['audio']) {
        isDisabled = true;
      }
      
      const card = document.createElement('div');
      card.className = `category-card ${tierClass} ${selected ? 'has-selection' : ''} ${isDisabled ? 'disabled' : ''}`;
      card.id = 'cat-' + cat.id;
      
      card.innerHTML = `
        <div class="category-header" onclick="toggleCategory('${cat.id}')">
          <div class="category-icon">${cat.icon}</div>
          <div class="category-info">
            <div class="category-name">${cat.name}</div>
            <div class="category-desc">${cat.desc}</div>
          </div>
          <div class="category-price ${!selected ? 'no-selection' : ''}">
            ${selected ? formatCurrency(price) : 'Not selected'}
          </div>
        </div>
        <div class="category-body">
          <div class="tier-selector">
            <div class="tier-btn none-btn ${!selected ? 'selected' : ''}" onclick="selectTier('${cat.id}', null)">
              <div class="tier-label">Skip</div>
              <div class="tier-price">‚Äî</div>
              <div class="tier-tag">Not included</div>
            </div>
            ${Object.keys(cat.tiers).map(t => {
              const tp = getCategoryPrice(cat, t);
              // Check if this tier should be disabled
              let tierDisabled = false;
              if (cat.id === 'lighting-designer' && t === 'best' && state.selections['lighting']) {
                tierDisabled = true; // Bespoke not available with Wireless Lighting
              }
              return `
                <div class="tier-btn ${t}-btn ${selected === t ? 'selected' : ''} ${tierDisabled ? 'tier-disabled' : ''}" ${tierDisabled ? '' : `onclick="selectTier('${cat.id}', '${t}')"`}>
                  <div class="tier-label">${cat.tiers[t].label}</div>
                  <div class="tier-price">${tierDisabled ? 'N/A' : formatCurrency(tp)}</div>
                  <div class="tier-tag">${tierDisabled ? 'Not available' : (cat.tiers[t].tag || t.charAt(0).toUpperCase() + t.slice(1))}</div>
                </div>
              `;
            }).join('')}
          </div>
          ${selected ? renderTierDetails(cat, selected) : '<div class="tier-details" style="text-align:center;color:var(--text-lighter);padding:20px;">Select a tier to see what\'s included</div>'}
          <div class="cat-modifier" style="padding:8px 16px 12px;border-top:1px dashed var(--border);display:flex;gap:8px;align-items:center;">
            <span style="font-size:12px;color:var(--text-lighter);white-space:nowrap;">¬± Adjust:</span>
            <input type="text" placeholder="Note" value="${(state.catMods[cat.id]?.name || '').replace(/"/g, '&quot;')}" 
              oninput="updateCatMod('${cat.id}', 'name', this.value)"
              onclick="event.stopPropagation()"
              style="flex:1;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;min-width:0;">
            <input type="text" inputmode="numeric" placeholder="$0" value="${state.catMods[cat.id]?.amount ? formatCurrency(state.catMods[cat.id].amount) : ''}" 
              oninput="handleCatModAmount(this, '${cat.id}')"
              onclick="event.stopPropagation()"
              style="width:110px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;text-align:right;">
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  });
}

function renderTierDetails(cat, tier) {
  const t = cat.tiers[tier];
  return `
    <div class="tier-details">
      <h4>${t.label} ‚Äî What's Included</h4>
      <ul>${t.features.map(f => `<li>${f}</li>`).join('')}</ul>
      <div class="brands">Typical brands: ${t.brands}</div>
    </div>
  `;
}

function getExtraPrice(e) {
  if (e.sizeScale !== undefined) {
    return Math.round(e.price * getSizeMultiplier(state.homeSize, e.sizeScale) / 100) * 100;
  }
  return e.price;
}

function renderExtras() {
  const section = document.getElementById('extrasSection');
  const grid = document.getElementById('extrasGrid');
  // Hide entire section if no extras for this property type
  if (EXTRAS().length === 0) { section.style.display = 'none'; return; }
  section.style.display = '';
  grid.innerHTML = '';
  EXTRAS().forEach(e => {
    const active = state.extras[e.id];
    const scaledPrice = getExtraPrice(e);
    const div = document.createElement('div');
    div.className = `extra-item ${active ? 'active' : ''}`;
    div.onclick = () => { state.extras[e.id] = !state.extras[e.id]; renderExtras(); updateTotals(); };
    div.innerHTML = `
      <div class="extra-info">
        <div>
          <div class="extra-name">${e.name}</div>
          <div class="extra-note">${e.note}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="extra-price">${formatCurrency(scaledPrice)}</div>
        <div class="extra-toggle"></div>
      </div>
    `;
    grid.appendChild(div);
  });
}

// ============================================================
// ACTIONS
// ============================================================
function handleModAmount(input, modId) {
  const raw = input.value.replace(/[^0-9.\-]/g, '');
  const num = parseFloat(raw) || 0;
  updateModifier(modId, 'amount', num);
  const cursorPos = input.selectionStart;
  const oldLen = input.value.length;
  if (raw === '' || raw === '-') {
    input.value = raw;
  } else {
    input.value = formatCurrency(num);
  }
  const newLen = input.value.length;
  const newPos = Math.max(0, cursorPos + (newLen - oldLen));
  input.setSelectionRange(newPos, newPos);
}

function handleCatModAmount(input, catId) {
  // Strip everything except digits, minus, and decimal
  const raw = input.value.replace(/[^0-9.\-]/g, '');
  const num = parseFloat(raw) || 0;
  updateCatMod(catId, 'amount', num);
  // Reformat with dollar sign and commas, preserving cursor
  const cursorPos = input.selectionStart;
  const oldLen = input.value.length;
  if (raw === '' || raw === '-') {
    input.value = raw;
  } else {
    input.value = formatCurrency(num);
  }
  const newLen = input.value.length;
  const newPos = Math.max(0, cursorPos + (newLen - oldLen));
  input.setSelectionRange(newPos, newPos);
}

function updateCatMod(catId, field, value) {
  if (!state.catMods[catId]) state.catMods[catId] = { name: '', amount: 0 };
  state.catMods[catId][field] = field === 'amount' ? parseFloat(value) || 0 : value;
  updateTotals();
  // Update the displayed price on the card header without full re-render
  const card = document.getElementById('cat-' + catId);
  if (card) {
    const priceEl = card.querySelector('.category-price');
    const tier = state.selections[catId];
    if (tier && priceEl) {
      const cat = CATEGORIES().find(c => c.id === catId);
      const basePrice = getCategoryPrice(cat, tier);
      const modAmount = state.catMods[catId]?.amount || 0;
      const total = basePrice + modAmount;
      priceEl.textContent = formatCurrency(total);
    }
  }
}

function selectTier(catId, tier) {
  state.selections[catId] = tier;
  
  // Mutual exclusivity: Wireless Lighting <-> Centralized Lighting
  if (tier !== null) {
    if (catId === 'lighting') {
      state.selections['lighting-centralized'] = null;
      // Bespoke keypads not available with Wireless - clear if selected
      if (state.selections['lighting-designer'] === 'best') {
        state.selections['lighting-designer'] = null;
      }
      // Wireless Basic doesn't support designer keypads at all
      if (tier === 'good' && state.selections['lighting-designer']) {
        state.selections['lighting-designer'] = null;
      }
    } else if (catId === 'lighting-centralized') {
      state.selections['lighting'] = null;
    }
  }
  
  // Clear Invisible Speakers if Multi-Room Audio is deselected
  if (catId === 'audio' && tier === null) {
    state.selections['invisible-speakers'] = null;
  }
  
  // Remember which cards are open and scroll position
  const openCards = new Set();
  document.querySelectorAll('.category-card.open').forEach(c => openCards.add(c.id));
  const scrollY = window.scrollY;
  renderCategories();
  updateTotals();
  // Restore all previously open cards + the one we just selected
  openCards.add('cat-' + catId);
  openCards.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('open');
  });
  // Restore scroll after browser layout
  requestAnimationFrame(() => window.scrollTo(0, scrollY));
}

function toggleCategory(catId) {
  const card = document.getElementById('cat-' + catId);
  card.classList.toggle('open');
}

function expandAll() {
  document.querySelectorAll('.category-card').forEach(c => c.classList.add('open'));
}

function applyPreset(level, el) {
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  if (el) el.closest('.preset-btn').classList.add('active');
  
  if (level === 'none') {
    CATEGORIES().forEach(c => state.selections[c.id] = null);
  } else {
    CATEGORIES().forEach(c => {
      // If category has this tier, use it; otherwise pick the closest available
      if (c.tiers[level]) {
        state.selections[c.id] = level;
      } else {
        const tierKeys = Object.keys(c.tiers);
        const tierOrder = ['good','standard','better','best'];
        const targetIdx = tierOrder.indexOf(level);
        // Find the closest tier that exists in this category
        let closest = tierKeys[tierKeys.length - 1]; // default to highest
        for (let i = targetIdx; i >= 0; i--) {
          if (c.tiers[tierOrder[i]]) { closest = tierOrder[i]; break; }
        }
        state.selections[c.id] = closest;
      }
    });
  }
  renderCategories();
  updateTotals();
}

function updateTotals() {
  let subtotal = 0;
  let selectedCount = 0;
  
  CATEGORIES().forEach(cat => {
    const tier = state.selections[cat.id];
    if (tier) {
      subtotal += getCategoryPrice(cat, tier);
      const catModAmount = state.catMods[cat.id]?.amount || 0;
      subtotal += catModAmount;
      selectedCount++;
    }
  });
  
  // Extras
  let extrasTotal = 0;
  EXTRAS().forEach(e => {
    if (state.extras[e.id]) extrasTotal += getExtraPrice(e);
  });

  // Modifiers
  let modifiersTotal = 0;
  state.modifiers.forEach(m => modifiersTotal += m.amount);
  
  const equipmentSubtotal = subtotal + extrasTotal + modifiersTotal;
  const taxEstimate = Math.round(equipmentSubtotal * 0.07); // FL ~7% sales tax on equipment
  const grandTotal = equipmentSubtotal + taxEstimate;
  const catCount = CATEGORIES().length;
  
  // Update displays
  document.getElementById('headerTotal').textContent = formatCurrency(grandTotal);
  document.getElementById('statSubtotal').textContent = formatCurrency(equipmentSubtotal);
  document.getElementById('statTax').textContent = formatCurrency(taxEstimate);
  document.getElementById('categoryCount').textContent = selectedCount + ' of ' + catCount + ' selected';
  
  // Trigger auto-save for live budgets
  triggerAutoSave();
}

// ============================================================
// SUMMARY
// ============================================================
function showSummary() {
  const modal = document.getElementById('summaryModal');
  const body = document.getElementById('summaryBody');
  
  const clientName = document.getElementById('clientName').value || 'Unnamed Project';
  const builder = document.getElementById('builder').value || '‚Äî';
  const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  
  let subtotal = 0;
  let rows = '';
  
  CATEGORIES().forEach(cat => {
    const tier = state.selections[cat.id];
    if (tier) {
      const price = getCategoryPrice(cat, tier);
      const catMod = state.catMods[cat.id];
      const catModAmount = catMod?.amount || 0;
      const t = cat.tiers[tier];
      subtotal += price + catModAmount;
      rows += `
        <tr>
          <td>${cat.icon} ${cat.name}</td>
          <td><span class="tier-badge ${tier}">${t.tag || tier.charAt(0).toUpperCase() + tier.slice(1)}</span> ${t.label}</td>
          <td class="price-cell">${formatCurrency(price)}</td>
        </tr>
        <tr class="features-row">
          <td colspan="3" style="padding:4px 16px 14px 36px;border-top:none;">
            <div style="font-size:11px;color:var(--text-light);line-height:1.6;">
              ${t.features.map(f => `‚Ä¢ ${f}`).join('<br>')}
              <div style="margin-top:4px;font-size:10px;color:var(--text-light);font-style:italic;">Typical brands: ${t.brands}</div>
            </div>
          </td>
        </tr>
      `;
      if (catModAmount !== 0) {
        rows += `
          <tr>
            <td style="padding-left:36px;">‚Ü≥ ${catMod.name || 'Adjustment'}</td>
            <td style="font-size:12px;color:var(--text-lighter);">${catModAmount > 0 ? 'Addition' : 'Credit'}</td>
            <td class="price-cell">${formatCurrency(catModAmount)}</td>
          </tr>
        `;
      }
    }
  });
  
  let extrasTotal = 0;
  EXTRAS().forEach(e => {
    if (state.extras[e.id]) {
      const extraPrice = getExtraPrice(e);
      extrasTotal += extraPrice;
      rows += `
        <tr>
          <td>üìé ${e.name}</td>
          <td style="font-size:12px;color:var(--text-lighter);">${e.note}</td>
          <td class="price-cell">${formatCurrency(extraPrice)}</td>
        </tr>
      `;
    }
  });

  let modifiersTotal = 0;
  state.modifiers.forEach(m => {
    if (m.amount !== 0) {
      modifiersTotal += m.amount;
      rows += `
        <tr>
          <td>üîß ${m.name || 'Custom Adjustment'}</td>
          <td style="font-size:12px;color:var(--text-lighter);">${m.amount > 0 ? 'Addition' : 'Credit'}</td>
          <td class="price-cell">${formatCurrency(m.amount)}</td>
        </tr>
      `;
    }
  });
  
  const equipmentSubtotal = subtotal + extrasTotal + modifiersTotal;
  const taxEstimate = Math.round(equipmentSubtotal * 0.07);
  const grandTotal = equipmentSubtotal + taxEstimate;
  
  body.innerHTML = `
    <div style="text-align:center;margin-bottom:20px;">
      <div style="display:inline-block;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1107 250" height="50"><defs><style>.sm-1{fill:#fff;}.sm-2{fill:#0F2F44;}.sm-3{fill:#017ed7;}</style></defs><g><path class="sm-2" d="M320.009,99.228v-28.137c0-4.98-.999-8.466-3.498-11.454-1.249-1.245-3.248-1.992-5.497-1.992-4.747,0-6.996,3.486-7.995,6.723-.75,1.992-.999,4.233-.999,6.723v110.059c0,5.229,1.249,8.715,3.748,11.454,1.249,1.245,2.998,1.992,5.247,1.992,4.747,0,6.996-2.988,7.995-6.723,.75-1.743,.999-3.984,.999-6.723v-33.117h-10.743v-22.659h37.726v91.134h-15.99l-3.248-8.715c-4.997,6.225-12.242,10.707-20.987,10.707s-14.741-2.241-19.238-6.225c-4.497-3.735-7.495-8.466-9.494-13.446-2.249-5.727-3.248-12.45-2.998-19.92V71.091c.25-7.221,1.749-13.944,4.497-19.671,2.249-4.98,5.497-9.96,10.493-13.695,4.997-3.735,11.992-6.225,20.987-6.225s15.74,2.49,20.737,6.225,8.495,8.715,10.743,13.695c2.748,5.727,4.247,12.45,4.497,19.671v28.137h-26.983Z"/><path class="sm-2" d="M359.23,216.508l27.733-183.016h32.979l27.733,183.016h-26.233l-4.997-37.35h-25.984l-4.997,37.35h-26.233Zm45.721-123.505l-.75-4.731h-1.499l-.75,4.731-7.745,57.768h18.488l-7.745-57.768Z"/><path class="sm-2" d="M504.887,216.508l-17.239-115.039-.999-7.719h-1.499v122.758h-24.984V33.492h32.979l15.99,83.664,1.249,9.711h.5l1.249-9.711,15.99-83.664h32.979V216.508h-24.984V93.75h-1.499l-.999,7.719-17.239,115.039h-11.493Z"/><path class="sm-2" d="M625.809,216.508l-17.239-115.039-.999-7.719h-1.499v122.758h-24.984V33.492h32.979l15.99,83.664,1.249,9.711h.5l1.249-9.711,15.99-83.664h32.979V216.508h-24.984V93.75h-1.499l-.999,7.719-17.239,115.039h-11.493Z"/><path class="sm-2" d="M694.514,216.508l27.733-183.016h32.979l27.733,183.016h-26.233l-4.997-37.35h-25.984l-4.997,37.35h-26.233Zm45.721-123.505l-.75-4.731h-1.499l-.75,4.731-7.745,57.768h18.488l-7.745-57.768Z"/><path class="sm-3" d="M780.461,61.131v-27.639h77.951v27.639h-25.484V216.508h-26.983V61.131h-25.484Z"/><path class="sm-3" d="M868.904,33.492h61.711v27.639h-34.728v48.057h24.984v29.382h-24.984v50.298h34.728v27.639h-61.711V33.492Z"/><path class="sm-3" d="M1015.809,153.76v25.149c-.25,7.47-1.749,14.193-4.497,19.92-2.249,4.98-5.746,9.711-10.743,13.446-4.997,3.984-11.743,6.225-20.737,6.225s-15.99-2.241-20.987-6.225c-4.997-3.735-8.245-8.466-10.493-13.446-2.748-5.727-4.247-12.45-4.497-19.92V71.091c.25-7.221,1.749-13.944,4.497-19.671,2.249-4.98,5.497-9.96,10.493-13.695s11.992-6.225,20.987-6.225,15.74,2.49,20.737,6.225,8.495,8.715,10.743,13.695c2.748,5.727,4.247,12.45,4.497,19.671v25.149h-25.234v-25.149c0-4.98-1.249-8.466-3.997-11.454-1.249-1.245-3.498-1.992-6.246-1.992-4.747,0-6.996,3.486-8.245,6.723-.75,1.992-.999,4.233-1.249,6.723v107.818c.25,5.229,1.749,8.715,4.247,11.454,1.249,1.245,2.998,1.992,5.247,1.992,5.746,0,7.995-2.988,9.244-6.723,.75-1.743,.999-3.984,.999-6.723v-25.149h25.234Z"/><path class="sm-3" d="M1080.017,136.828h-20.987v79.68h-26.983V33.492h26.983V109.188h20.987V33.492h26.983V216.508h-26.983v-79.68Z"/></g><g><path class="sm-3" d="M250,125c0,68.361-54.876,123.904-122.98,124.982v-16.333c59.086-1.076,106.649-49.306,106.649-108.649h-96.874v-16.414h95.641c-7.813-51.581-51.886-91.26-105.417-92.235V.018c68.104,1.078,122.98,56.621,122.98,124.982Z"/><path class="sm-2" d="M136.795,108.586h79.01c-1.194-6.679-3.131-13.194-5.793-19.49-4.646-10.985-11.301-20.854-19.778-29.331-8.477-8.477-18.346-15.131-29.331-19.778-6.295-2.662-12.811-4.599-19.49-5.793-4.722-.848-9.528-1.326-14.394-1.427-.672-.015-1.346-.023-2.02-.023s-1.349,.008-2.02,.023c-4.866,.101-9.672,.578-14.394,1.427-6.679,1.194-13.194,3.131-19.49,5.793-10.985,4.646-20.854,11.301-29.331,19.778-8.477,8.477-15.131,18.346-19.778,29.331-4.806,11.361-7.242,23.442-7.242,35.904s2.437,24.543,7.242,35.904c4.646,10.985,11.301,20.854,19.778,29.331,8.477,8.477,18.346,15.131,29.331,19.778,6.295,2.662,12.811,4.599,19.49,5.793,4.722,.848,9.528,1.326,14.394,1.427,.672,.015,1.346,.023,2.02,.023s1.349-.008,2.02-.023c4.866-.101,9.672-.578,14.394-1.427,6.679-1.194,13.194-3.131,19.49-5.793,10.985-4.646,20.854-11.301,29.331-19.778,8.477-8.477,15.131-18.346,19.778-29.331,2.662-6.295,4.598-12.811,5.793-19.49h-79.01v-32.828Zm-13.816-92.235V.018C54.876,1.096,0,56.639,0,125s54.876,123.904,122.98,124.982v-16.333c-59.086-1.076-106.649-49.306-106.649-108.649S63.894,17.427,122.98,16.351Z"/><path class="sm-1" d="M233.669,125c0,59.343-47.563,107.573-106.649,108.649v16.333l-2.02,.018-2.02-.018v-16.333c-59.086-1.076-106.649-49.306-106.649-108.649S63.894,17.427,122.98,16.351V.018c.672-.013,1.346-.018,2.02-.018s1.349,.005,2.02,.018V16.351c53.53,.975,97.604,40.654,105.417,92.235h-16.631c-1.194-6.679-3.131-13.194-5.793-19.49-4.646-10.985-11.301-20.854-19.778-29.331-8.477-8.477-18.346-15.131-29.331-19.778-6.295-2.662-12.811-4.599-19.49-5.793-4.722-.848-9.528-1.326-14.394-1.427-.672-.015-1.346-.023-2.02-.023s-1.349,.008-2.02,.023c-4.866,.101-9.672,.578-14.394,1.427-6.679,1.194-13.194,3.131-19.49,5.793-10.985,4.646-20.854,11.301-29.331,19.778-8.477,8.477-15.131,18.346-19.778,29.331-4.806,11.361-7.242,23.442-7.242,35.904s2.437,24.543,7.242,35.904c4.646,10.985,11.301,20.854,19.778,29.331,8.477,8.477,18.346,15.131,29.331,19.778,6.295,2.662,12.811,4.599,19.49,5.793,4.722,.848,9.528,1.326,14.394,1.427,.672,.015,1.346,.023,2.02,.023s1.349-.008,2.02-.023c4.866-.101,9.672-.578,14.394-1.427,6.679-1.194,13.194-3.131,19.49-5.793,10.985-4.646,20.854-11.301,29.331-19.778,8.477-8.477,15.131-18.346,19.778-29.331,2.662-6.295,4.598-12.811,5.793-19.49h-79.01v-16.414h96.874Z"/></g></svg></div>
      <div style="font-size:12px;color:var(--text-lighter);margin-top:8px;">Residential Technology Budget Estimate</div>
    </div>
    
    <div class="summary-project-info">
      <div><span class="info-label">Project:</span></div>
      <div><span class="info-value">${clientName}</span></div>
      <div><span class="info-label">Builder:</span></div>
      <div><span class="info-value">${builder}</span></div>
      <div><span class="info-label">Property Type:</span></div>
      <div><span class="info-value">${state.propertyType === 'residential' ? 'Single Family' : 'Condo'}</span></div>
      <div><span class="info-label">Home Size:</span></div>
      <div><span class="info-value">${state.homeSize.toLocaleString()} sq ft</span></div>
      <div><span class="info-label">Date:</span></div>
      <div><span class="info-value">${today}</span></div>
      <div><span class="info-label">Prepared by:</span></div>
      <div><span class="info-value">Gamma Tech Services</span></div>
    </div>
    
    <table class="summary-table">
      <thead>
        <tr>
          <th>Category</th>
          <th>Tier</th>
          <th style="text-align:right;">Estimated Cost</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2">Equipment & Installation Subtotal</td>
          <td class="price-cell">${formatCurrency(equipmentSubtotal)}</td>
        </tr>
        <tr>
          <td colspan="2">Estimated Sales Tax (~7%)</td>
          <td class="price-cell">${formatCurrency(taxEstimate)}</td>
        </tr>
        <tr>
          <td colspan="2" style="font-size:18px;">Estimated Total Investment</td>
          <td class="price-cell grand-total">${formatCurrency(grandTotal)}</td>
        </tr>
      </tfoot>
    </table>
    
    <div class="disclaimer">
      This is a budgetary estimate for planning purposes. Final pricing requires detailed design and engineering.<br>
      ‚Ä¢ TV/display costs are generally not included unless noted (video wall categories).<br>
      ‚Ä¢ Prices reflect new construction; retrofit projects may require additional assessment.<br>
      ‚Ä¢ Equipment availability and pricing subject to change. Lead times vary by manufacturer.<br>
      ‚Ä¢ Sales tax estimate based on FL rate (~7%); actual tax depends on installation location.<br>
      ‚Ä¢ Permits may be required for security, low-voltage, and electrical work per FL code.<br>
      <br>
      <strong>Gamma Tech Services</strong> ‚Ä¢ (239) 330-4939 ‚Ä¢ gamma.tech<br>
      3106 Horseshoe Dr S, Naples, FL 34116 ‚Ä¢ FL License #EG13000578
    </div>
    <div style="text-align:center;margin-top:20px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
      <button onclick="shareLink();closeSummary();" style="background:var(--accent);color:white;border:none;padding:14px 32px;border-radius:var(--radius-sm);font-size:15px;font-weight:600;cursor:pointer;transition:var(--transition);">üîó Share Link</button>
      <button onclick="closeSummary();showEmailModal();" style="background:var(--primary);color:white;border:none;padding:14px 32px;border-radius:var(--radius-sm);font-size:15px;font-weight:600;cursor:pointer;transition:var(--transition);">üìß Email Budget</button>
    </div>
  `;
  
  modal.classList.add('active');
}

function closeSummary() {
  document.getElementById('summaryModal').classList.remove('active');
}

// ============================================================
// EMAIL FUNCTIONS
// ============================================================
function showEmailModal() {
  // Pre-fill recipient name from client name if available
  const clientName = document.getElementById('clientName').value;
  if (clientName) {
    document.getElementById('emailRecipientName').value = clientName;
  }
  
  // Reset status
  const statusEl = document.getElementById('emailStatus');
  statusEl.style.display = 'none';
  document.getElementById('emailSendBtn').disabled = false;
  document.getElementById('emailSendBtn').textContent = 'üìß Send Email';
  
  document.getElementById('emailModal').classList.add('active');
}

function closeEmailModal() {
  document.getElementById('emailModal').classList.remove('active');
}

async function sendProposalEmail() {
  const recipientName = document.getElementById('emailRecipientName').value.trim();
  const recipientEmail = document.getElementById('emailRecipientEmail').value.trim();
  const subject = document.getElementById('emailSubject').value.trim() || 'Your Technology Budget from Gamma Tech';
  
  const statusEl = document.getElementById('emailStatus');
  const sendBtn = document.getElementById('emailSendBtn');
  
  // Validate email
  if (!recipientEmail) {
    statusEl.style.display = 'block';
    statusEl.style.background = '#FFEBEE';
    statusEl.style.color = '#C62828';
    statusEl.textContent = '‚ö†Ô∏è Please enter a recipient email address.';
    return;
  }
  
  if (!recipientEmail.includes('@')) {
    statusEl.style.display = 'block';
    statusEl.style.background = '#FFEBEE';
    statusEl.style.color = '#C62828';
    statusEl.textContent = '‚ö†Ô∏è Please enter a valid email address.';
    return;
  }
  
  // Show loading state
  sendBtn.disabled = true;
  sendBtn.textContent = '‚è≥ Sending...';
  statusEl.style.display = 'none';
  
  // Build proposal data
  const categories = [];
  CATEGORIES().forEach(cat => {
    const tier = state.selections[cat.id];
    if (tier && cat.tiers[tier]) {
      const price = getCategoryPrice(cat, tier);
      categories.push({
        name: cat.name,
        tier: tier,
        price: price
      });
    }
  });
  
  // Calculate totals
  let subtotal = 0;
  CATEGORIES().forEach(cat => {
    const tier = state.selections[cat.id];
    if (tier && cat.tiers[tier]) subtotal += getCategoryPrice(cat, tier);
  });
  EXTRAS().forEach(e => {
    if (state.extras[e.id]) {
      subtotal += typeof e.cost === 'function' ? e.cost() : e.cost;
    }
  });
  state.modifiers.forEach(m => {
    subtotal += parseFloat(m.amount) || 0;
  });
  Object.keys(state.catMods).forEach(catId => {
    const m = state.catMods[catId];
    if (m && m.amount) subtotal += parseFloat(m.amount) || 0;
  });
  
  const taxRate = 0.075;
  const total = subtotal * (1 + taxRate);
  
  // Determine tier label
  let tierLabel = '';
  const tierCounts = { good: 0, standard: 0, better: 0, best: 0 };
  Object.values(state.selections).forEach(t => { if (t) tierCounts[t]++; });
  const maxCount = Math.max(...Object.values(tierCounts));
  const dominantTier = Object.keys(tierCounts).find(k => tierCounts[k] === maxCount && maxCount > 0);
  if (dominantTier) {
    const labels = { good: 'Good Tier', standard: 'Standard Tier', better: 'Better Tier', best: 'Best Tier' };
    tierLabel = labels[dominantTier] || '';
  }
  
  const clientName = document.getElementById('clientName').value || '';
  
  // Get or create budget link
  let budgetUrl = null;
  
  if (currentBudgetId) {
    // Already in a budget ‚Äî use its link (save + pin version)
    try {
      await fetch(api(`/api/budgets/${currentBudgetId}`), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: getStateForAPI(), pin: true, note: 'Emailed to client' })
      });
    } catch (e) {
      console.warn('Could not save before emailing:', e);
    }
    budgetUrl = window.location.origin + '/b/' + currentBudgetId;
  } else {
    // No budget yet ‚Äî create one
    try {
      const budgetResponse = await fetch(api('/api/budgets'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          state: getStateForAPI(),
          clientName: clientName
        })
      });
      const budgetResult = await budgetResponse.json();
      if (budgetResponse.ok && budgetResult.success) {
        budgetUrl = window.location.origin + budgetResult.url;
        // Update page to use this budget
        currentBudgetId = budgetResult.id;
        window.history.replaceState({}, '', budgetResult.url);
      }
    } catch (e) {
      console.warn('Could not create live budget for email:', e);
    }
  }
  
  const proposalData = {
    categories,
    total: Math.round(total),
    tierLabel,
    clientName: clientName,
    builder: document.getElementById('builder').value || '',
    homeSize: state.homeSize,
    budgetUrl: budgetUrl
  };
  
  try {
    const response = await fetch(api('/api/send-proposal'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recipientEmail,
        recipientName,
        subject,
        proposalData
      })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      statusEl.style.display = 'block';
      statusEl.style.background = '#E8F5E9';
      statusEl.style.color = '#2E7D32';
      statusEl.textContent = '‚úÖ Email sent successfully!';
      sendBtn.textContent = '‚úì Sent!';
      
      // Close modal after delay
      setTimeout(() => {
        closeEmailModal();
        showToast('üìß Budget emailed to ' + recipientEmail);
      }, 1500);
    } else {
      throw new Error(result.error || 'Failed to send email');
    }
  } catch (err) {
    console.error('Email error:', err);
    statusEl.style.display = 'block';
    statusEl.style.background = '#FFEBEE';
    statusEl.style.color = '#C62828';
    statusEl.textContent = '‚ùå ' + (err.message || 'Failed to send email. Please try again.');
    sendBtn.disabled = false;
    sendBtn.textContent = 'üìß Send Email';
  }
}

// ============================================================
// HELPERS
// ============================================================
function formatCurrency(n) {
  if (n < 0) return '-$' + Math.abs(Math.round(n)).toLocaleString('en-US');
  return '$' + Math.round(n).toLocaleString('en-US');
}

// ============================================================
// CUSTOM MODIFIERS
// ============================================================
let modifierId = 0;

function addModifier() {
  state.modifiers.push({ id: ++modifierId, name: '', amount: 0 });
  renderModifiers();
}

function removeModifier(id) {
  state.modifiers = state.modifiers.filter(m => m.id !== id);
  renderModifiers();
  updateTotals();
}

function updateModifier(id, field, value) {
  const mod = state.modifiers.find(m => m.id === id);
  if (mod) {
    mod[field] = field === 'amount' ? parseFloat(value) || 0 : value;
    updateTotals();
  }
}

function renderModifiers() {
  const container = document.getElementById('modifiersContainer');
  container.innerHTML = state.modifiers.map(m => `
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px;">
      <input type="text" placeholder="Description" value="${m.name}" 
        oninput="updateModifier(${m.id}, 'name', this.value)"
        style="flex:1;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;">
      <input type="text" inputmode="numeric" placeholder="$0" value="${m.amount ? formatCurrency(m.amount) : ''}" 
        oninput="handleModAmount(this, ${m.id})"
        style="width:130px;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;text-align:right;">
      <button onclick="removeModifier(${m.id})" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--red);cursor:pointer;padding:8px 12px;font-size:16px;">‚úï</button>
    </div>
  `).join('');
}

// ============================================================
// EVENT LISTENERS
// ============================================================
document.getElementById('propertyType').addEventListener('change', function() {
  state.propertyType = this.value;
  initStateForConfig();
  renderCategories();
  renderExtras();
  renderModifiers();
  updateTotals();
});

document.getElementById('homeSize').addEventListener('input', function() {
  let val = parseInt(this.value) || 4000;
  if (val > 35000) { val = 35000; this.value = 35000; }
  state.homeSize = val;
  renderCategories();
  renderExtras();
  updateTotals();
});

// Close modal on overlay click
document.getElementById('summaryModal').addEventListener('click', function(e) {
  if (e.target === this) closeSummary();
});

// Keyboard
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeSummary();
});

// ============================================================
// SHAREABLE LINK
// ============================================================
function encodeState() {
  const params = new URLSearchParams();
  
  // Project details
  const clientName = document.getElementById('clientName').value;
  const builder = document.getElementById('builder').value;
  if (clientName) params.set('client', clientName);
  if (builder) params.set('builder', builder);
  params.set('sqft', state.homeSize);
  params.set('prop', state.propertyType);
  
  // Category selections (only non-null)
  const sel = {};
  CATEGORIES().forEach(c => {
    if (state.selections[c.id]) sel[c.id] = state.selections[c.id];
  });
  if (Object.keys(sel).length > 0) params.set('sel', JSON.stringify(sel));
  
  // Extras (only ones that differ from default)
  const ext = {};
  EXTRAS().forEach(e => {
    if (state.extras[e.id] !== e.default) ext[e.id] = state.extras[e.id];
  });
  if (Object.keys(ext).length > 0) params.set('ext', JSON.stringify(ext));
  
  // Custom modifiers
  if (state.modifiers.length > 0) {
    const mods = state.modifiers
      .filter(m => m.name || m.amount)
      .map(m => ({ n: m.name, a: m.amount }));
    if (mods.length > 0) params.set('mods', JSON.stringify(mods));
  }
  
  // Per-category adjustments (only non-empty ones)
  const cm = {};
  Object.keys(state.catMods).forEach(catId => {
    const m = state.catMods[catId];
    if (m && (m.name || m.amount)) cm[catId] = { n: m.name, a: m.amount };
  });
  if (Object.keys(cm).length > 0) params.set('cm', JSON.stringify(cm));
  
  return params.toString();
}

function decodeState(search) {
  const params = new URLSearchParams(search);
  let loaded = false;
  
  // Property type ‚Äî must be set first so categories resolve correctly
  if (params.has('prop')) {
    const p = params.get('prop');
    if (CONFIGS[p]) {
      state.propertyType = p;
      document.getElementById('propertyType').value = p;
      initStateForConfig();
      loaded = true;
    }
  }
  
  // Project details
  if (params.has('client')) {
    document.getElementById('clientName').value = params.get('client');
    loaded = true;
  }
  if (params.has('builder')) {
    document.getElementById('builder').value = params.get('builder');
    loaded = true;
  }
  if (params.has('sqft')) {
    const sqft = parseInt(params.get('sqft'));
    if (sqft >= 1500 && sqft <= 20000) {
      state.homeSize = sqft;
      document.getElementById('homeSize').value = sqft;
      loaded = true;
    }
  }
  // Category selections
  if (params.has('sel')) {
    try {
      const sel = JSON.parse(params.get('sel'));
      const validTiers = ['good', 'standard', 'better', 'best'];
      Object.keys(sel).forEach(catId => {
        if (state.selections.hasOwnProperty(catId) && validTiers.includes(sel[catId])) {
          state.selections[catId] = sel[catId];
          loaded = true;
        }
      });
      // Re-apply mutual exclusivity rules
      if (state.selections['lighting'] && state.selections['lighting-centralized']) {
        state.selections['lighting-centralized'] = null;
      }
    } catch (e) { /* ignore bad JSON */ }
  }
  
  // Extras
  if (params.has('ext')) {
    try {
      const ext = JSON.parse(params.get('ext'));
      Object.keys(ext).forEach(extId => {
        if (state.extras.hasOwnProperty(extId)) {
          state.extras[extId] = !!ext[extId];
          loaded = true;
        }
      });
    } catch (e) { /* ignore bad JSON */ }
  }
  
  // Custom modifiers
  if (params.has('mods')) {
    try {
      const mods = JSON.parse(params.get('mods'));
      if (Array.isArray(mods)) {
        state.modifiers = mods.map(m => ({
          id: ++modifierId,
          name: String(m.n || ''),
          amount: parseFloat(m.a) || 0
        }));
        loaded = true;
      }
    } catch (e) { /* ignore bad JSON */ }
  }
  
  // Per-category adjustments
  if (params.has('cm')) {
    try {
      const cm = JSON.parse(params.get('cm'));
      Object.keys(cm).forEach(catId => {
        if (state.catMods.hasOwnProperty(catId)) {
          state.catMods[catId] = {
            name: String(cm[catId].n || ''),
            amount: parseFloat(cm[catId].a) || 0
          };
          loaded = true;
        }
      });
    } catch (e) { /* ignore bad JSON */ }
  }
  
  return loaded;
}

// ============================================================
// LIVE BUDGET SYSTEM
// ============================================================

let currentBudgetId = null;
let autoSaveTimeout = null;
let lastSavedState = null;

// Note: isCustomizedBudget, customCategoryConfig, customCategories, sqftLocked, propertyTypeLocked
// are declared earlier (before CATEGORIES function) to avoid temporal dead zone errors

// Get current state as object for API
function getStateForAPI() {
  const clientName = document.getElementById('clientName').value || null;
  const homeSize = parseInt(document.getElementById('homeSize').value) || 4000;
  const propertyType = document.getElementById('propertyType').value || 'residential';
  
  // Get total from the header display (already calculated)
  const totalText = document.getElementById('headerTotal').textContent;
  const total = parseInt(totalText.replace(/[^0-9]/g, '')) || 0;
  
  return {
    selections: { ...state.selections },
    extras: { ...state.extras },
    modifiers: [...state.modifiers],
    catMods: { ...state.catMods },
    homeSize,
    propertyType,
    clientName,
    total
  };
}

// Auto-save for live budgets
function triggerAutoSave() {
  if (!currentBudgetId) return;
  
  // Clear existing timeout
  if (autoSaveTimeout) {
    clearTimeout(autoSaveTimeout);
  }
  
  // Debounce: save after 2 seconds of no changes
  autoSaveTimeout = setTimeout(async () => {
    const currentState = getStateForAPI();
    
    // Skip if no actual changes
    if (lastSavedState && JSON.stringify(currentState) === JSON.stringify(lastSavedState)) {
      return;
    }
    
    try {
      const response = await fetch(api(`/api/budgets/${currentBudgetId}`), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: currentState })
      });
      
      if (response.ok) {
        lastSavedState = currentState;
        // Subtle save indicator
        showToast('‚úì Saved', 1000);
      }
    } catch (err) {
      console.error('Auto-save error:', err);
    }
  }, 2000);
}

// Load a live budget by ID
async function loadBudget(budgetId) {
  try {
    const response = await fetch(api(`/api/budgets/${budgetId}`));
    if (!response.ok) {
      throw new Error('Budget not found');
    }
    
    const budget = await response.json();
    
    // Set current budget ID for auto-save
    currentBudgetId = budget.id;
    
    // Load customization config if present
    isCustomizedBudget = budget.isCustomized || false;
    customCategoryConfig = budget.categoryConfig || null;
    customCategories = budget.customCategories || null;
    sqftLocked = budget.sqftLocked || null;
    propertyTypeLocked = budget.propertyTypeLocked || null;
    
    // Apply state
    if (budget.currentState) {
      const s = budget.currentState;
      
      // Apply state properties
      state.selections = s.selections || {};
      state.extras = s.extras || {};
      state.modifiers = s.modifiers || [];
      state.catMods = s.catMods || {};
      state.homeSize = s.homeSize || 4000;
      state.propertyType = s.propertyType || 'residential';
      
      // Update form fields
      document.getElementById('homeSize').value = state.homeSize;
      document.getElementById('propertyType').value = state.propertyType;
      
      if (s.clientName) {
        document.getElementById('clientName').value = s.clientName;
      }
      
      // If customized, silently lock sqft and property type fields
      if (isCustomizedBudget) {
        document.getElementById('homeSize').disabled = true;
        document.getElementById('propertyType').disabled = true;
      }
      
      // Render UI
      renderCategories();
      renderExtras();
      renderModifiers();
      updateTotals();
      
      // Store as last saved state AFTER rendering to prevent immediate re-save
      setTimeout(() => {
        lastSavedState = getStateForAPI();
      }, 100);
    }
    
    return true;
  } catch (err) {
    console.error('Load budget error:', err);
    showToast('‚ùå Could not load budget');
    return false;
  }
}

// Share link - creates a new live budget
async function shareLink() {
  const currentState = getStateForAPI();
  
  // If we're already in a budget, just copy its link (and pin current state)
  if (currentBudgetId) {
    // Save + pin current state
    try {
      await fetch(api(`/api/budgets/${currentBudgetId}`), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: currentState, pin: true, note: 'Shared link' })
      });
      lastSavedState = currentState;
    } catch (e) {
      console.warn('Could not save before sharing:', e);
    }
    
    const budgetUrl = window.location.origin + '/b/' + currentBudgetId;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(budgetUrl).then(() => {
        showToast('üîó Link copied!');
      }).catch(() => {
        fallbackCopy(budgetUrl);
      });
    } else {
      fallbackCopy(budgetUrl);
    }
    return;
  }
  
  // No budget yet ‚Äî create a new one
  try {
    showToast('‚è≥ Creating link...');
    
    const response = await fetch(api('/api/budgets'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        state: currentState,
        clientName: currentState.clientName
      })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      const budgetUrl = window.location.origin + result.url;
      
      // Update current page to use this budget ID (enable auto-save)
      currentBudgetId = result.id;
      lastSavedState = currentState;
      
      // Update URL without reload
      window.history.replaceState({}, '', result.url);
      
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(budgetUrl).then(() => {
          showToast('üîó Link copied!');
        }).catch(() => {
          fallbackCopy(budgetUrl);
        });
      } else {
        fallbackCopy(budgetUrl);
      }
    } else {
      throw new Error(result.error || 'Failed to create link');
    }
  } catch (err) {
    console.error('Share link error:', err);
    showToast('‚ùå ' + (err.message || 'Failed to create link'));
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try {
    document.execCommand('copy');
    showToast('üîó Link copied to clipboard!');
  } catch (e) {
    showToast('Link generated ‚Äî copy from address bar');
    // Update address bar so they can copy manually
    window.history.replaceState(null, '', '?' + encodeState());
  }
  document.body.removeChild(ta);
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('visible');
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => toast.classList.remove('visible'), 3000);
}

function showSharedBanner() {
  const banner = document.getElementById('sharedBanner');
  const clientName = document.getElementById('clientName').value || 'this project';
  banner.innerHTML = `
    <div class="shared-banner" style="max-width:1200px;margin:20px auto;">
      <div class="shared-text">
        üìã You're viewing a shared budget configuration for <strong>${clientName}</strong>
        <small>Adjust selections freely. Use the Share button to save your changes as a new link.</small>
      </div>
      <button class="btn-save" onclick="bookmarkConfig()">üìå Save to Bookmarks</button>
    </div>
  `;
}

function bookmarkConfig() {
  // Update the URL bar with current state so they can bookmark it
  const encoded = encodeState();
  const url = window.location.origin + window.location.pathname + '?' + encoded;
  window.history.replaceState(null, '', '?' + encoded);
  
  // Try to trigger browser bookmark dialog (Ctrl+D hint)
  showToast('üìå URL updated ‚Äî press Ctrl+D (‚åò+D on Mac) to bookmark!');
}

// ============================================================
// INIT
// ============================================================

// Check for live budget URL (/b/:id) - account for BASE_PATH prefix
const budgetPathPattern = BASE_PATH ? new RegExp(`^${BASE_PATH}\\/b\\/([a-z0-9]+)$`, 'i') : /^\/b\/([a-z0-9]+)$/i;
const budgetMatch = window.location.pathname.match(budgetPathPattern);
let _loadedFromURL = false;

if (budgetMatch) {
  // Load live budget
  loadBudget(budgetMatch[1]).then(loaded => {
    if (loaded) {
      showSharedBanner();
    }
  });
  _loadedFromURL = true;
} else {
  // Check for legacy shared config in URL
  _loadedFromURL = decodeState(window.location.search);
}

renderCategories();
renderExtras();
renderModifiers();
updateTotals();

// Show banner if loaded from a shared link (legacy URL params)
if (_loadedFromURL && !budgetMatch) {
  showSharedBanner();
}

// Safety: re-sync state from DOM after browser form restoration (Safari restores form values)
window.addEventListener('pageshow', function() {
  const domSize = parseInt(document.getElementById('homeSize').value) || 4000;
  const domProp = document.getElementById('propertyType').value;
  if (domSize !== state.homeSize || domProp !== state.propertyType) {
    // If URL params exist, URL wins. Otherwise DOM wins.
    if (_loadedFromURL) {
      document.getElementById('homeSize').value = state.homeSize;
      document.getElementById('propertyType').value = state.propertyType;
    } else {
      state.homeSize = domSize;
      state.propertyType = domProp;
    }
    renderCategories();
    renderExtras();
    updateTotals();
  }
});
</script>
</body>
</html>
