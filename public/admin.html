<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budget Admin - Gamma Tech</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0F2F44;
      --primary-light: #133F5C;
      --accent: #017ED7;
      --bg: #F5F7FA;
      --card: #FFFFFF;
      --border: #E0E0E0;
      --text: #393939;
      --text-light: #5A5A5A;
      --success: #2E7D32;
      --warning: #F57C00;
      --danger: #D32F2F;
      --radius: 12px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* LOGIN PAGE */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    }
    
    .login-card h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--primary);
    }
    
    .login-card p {
      color: var(--text-light);
      margin-bottom: 24px;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #0069AF;
    }
    
    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .error-message {
      background: #FFEBEE;
      color: var(--danger);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }
    
    /* DASHBOARD */
    .dashboard {
      display: none;
    }
    
    .dashboard.active {
      display: block;
    }
    
    .header {
      background: var(--primary);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .user-info {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .header .btn {
      padding: 8px 16px;
      font-size: 13px;
    }
    
    .content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .stat-card .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
      margin-bottom: 4px;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .section-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .budget-table {
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .budget-table table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .budget-table th,
    .budget-table td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .budget-table th {
      background: var(--bg);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
    }
    
    .budget-table tr:last-child td {
      border-bottom: none;
    }
    
    .budget-table tr:hover td {
      background: #F8FAFC;
    }
    
    .budget-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }
    
    .budget-link:hover {
      text-decoration: underline;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-views {
      background: #E3F2FD;
      color: #1565C0;
    }
    
    .badge-versions {
      background: #E8F5E9;
      color: #2E7D32;
    }
    
    .actions-cell {
      display: flex;
      gap: 8px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: var(--card);
      border-radius: var(--radius);
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-header h2 {
      font-size: 18px;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-light);
      padding: 0;
      line-height: 1;
    }
    
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .detail-item {
      background: var(--bg);
      padding: 12px;
      border-radius: 8px;
    }
    
    .detail-item .label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-light);
      margin-bottom: 4px;
    }
    
    .detail-item .value {
      font-weight: 600;
      font-size: 15px;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .views-list, .versions-list {
      background: var(--bg);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .view-item, .version-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .view-item:last-child, .version-item:last-child {
      border-bottom: none;
    }
    
    .version-item .version-info {
      flex: 1;
    }
    
    .version-item .version-num {
      font-weight: 600;
      color: var(--accent);
    }
    
    .version-item .version-note {
      color: var(--text-light);
      font-size: 12px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-light);
    }
    
    .empty-state p {
      margin-bottom: 16px;
    }
    
    /* TOAST */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--primary);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }
    
    .toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    @media (max-width: 768px) {
      .budget-table { overflow-x: auto; }
      .budget-table table { min-width: 600px; }
      .header { flex-direction: column; gap: 12px; text-align: center; }
      .detail-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="login-container" id="loginPage">
  <div class="login-card">
    <!-- SIGN IN VIEW -->
    <div id="loginView">
      <h1>üîê Budget Admin</h1>
      <p>Sign in to manage budgets and view analytics</p>
      
      <div class="error-message" id="loginError"></div>
      
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginUsername" required autocomplete="username" placeholder="you@company.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Sign In</button>
      </form>
      <div style="text-align:center;margin-top:16px;">
        <a href="#" onclick="showForgotPassword(event)" style="color:var(--accent);font-size:13px;text-decoration:none;">Forgot your password?</a>
      </div>
    </div>
    
    <!-- FORGOT PASSWORD VIEW -->
    <div id="forgotView" style="display:none;">
      <h1>üîë Reset Password</h1>
      <p>Enter your email address and we'll send you a link to reset your password.</p>
      
      <div class="error-message" id="forgotError"></div>
      <div class="success-message" id="forgotSuccess" style="display:none;background:#E8F5E9;color:#2E7D32;padding:12px 16px;border-radius:8px;font-size:14px;margin-bottom:16px;"></div>
      
      <form onsubmit="handleForgotPassword(event)">
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="forgotEmail" required autocomplete="email" placeholder="you@company.com">
        </div>
        <button type="submit" class="btn btn-primary" id="forgotSubmitBtn" style="width:100%;">Send Reset Link</button>
      </form>
      <div style="text-align:center;margin-top:16px;">
        <a href="#" onclick="showLoginView(event)" style="color:var(--accent);font-size:13px;text-decoration:none;">‚Üê Back to Sign In</a>
      </div>
    </div>
    
    <!-- RESET PASSWORD VIEW (from email link) -->
    <div id="resetView" style="display:none;">
      <h1>üîí Set New Password</h1>
      <p>Enter your new password below.</p>
      
      <div class="error-message" id="resetError"></div>
      <div class="success-message" id="resetSuccess" style="display:none;background:#E8F5E9;color:#2E7D32;padding:12px 16px;border-radius:8px;font-size:14px;margin-bottom:16px;"></div>
      
      <form onsubmit="handleResetPassword(event)">
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="resetPassword" required autocomplete="new-password" minlength="8" placeholder="Minimum 8 characters">
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="resetPasswordConfirm" required autocomplete="new-password" minlength="8" placeholder="Re-enter your password">
        </div>
        <div id="passwordStrength" style="font-size:12px;margin-bottom:12px;"></div>
        <button type="submit" class="btn btn-primary" id="resetSubmitBtn" style="width:100%;">Set New Password</button>
      </form>
      <div style="text-align:center;margin-top:16px;">
        <a href="#" onclick="showLoginView(event)" style="color:var(--accent);font-size:13px;text-decoration:none;">‚Üê Back to Sign In</a>
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
  <header class="header">
    <h1>üìä Budget Dashboard</h1>
    <div class="header-actions">
      <span class="user-info" id="userInfo"></span>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
  </header>
  
  <div class="content">
    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="label">Total Budgets</div>
        <div class="value" id="statTotalBudgets">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Views</div>
        <div class="value" id="statTotalViews">-</div>
      </div>
      <div class="stat-card">
        <div class="label">This Week</div>
        <div class="value" id="statWeekBudgets">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Value</div>
        <div class="value" id="statTotalValue">-</div>
      </div>
    </div>
    
    <!-- Budget List -->
    <div class="section-header">
      <h2>All Budgets</h2>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-small" onclick="showNewBudgetModal()">+ New Custom Budget</button>
        <button class="btn btn-secondary btn-small" onclick="loadBudgets()">‚Üª Refresh</button>
      </div>
    </div>
    
    <div class="budget-table">
      <table>
        <thead>
          <tr>
            <th>Client</th>
            <th>Total</th>
            <th>Created</th>
            <th>Views</th>
            <th>Versions</th>
            <th>Last Activity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="budgetTableBody">
          <tr>
            <td colspan="7" class="empty-state">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Users Section -->
    <div class="section-header" style="margin-top: 40px;">
      <h2>üë§ Users</h2>
      <button class="btn btn-primary btn-small" onclick="showUserModal()">+ Add User</button>
    </div>
    
    <div class="budget-table">
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Name</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr>
            <td colspan="4" class="empty-state">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- NEW BUDGET MODAL -->
<div class="modal-overlay" id="newBudgetModal">
  <div class="modal" style="max-width: 500px;">
    <div class="modal-header">
      <h2>‚ûï New Custom Budget</h2>
      <button class="modal-close" onclick="closeNewBudgetModal()">√ó</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:20px;color:var(--text-light);">Create a blank budget to customize pricing for a specific project.</p>
      <form onsubmit="handleNewBudgetSubmit(event)">
        <div class="form-group">
          <label>Client Name</label>
          <input type="text" id="newBudgetClient" placeholder="e.g., Smith Residence">
        </div>
        <div class="form-group">
          <label>Builder</label>
          <input type="text" id="newBudgetBuilder" placeholder="e.g., ABC Homes">
        </div>
        <div class="form-group">
          <label>Square Footage *</label>
          <input type="number" id="newBudgetSqft" required min="500" max="50000" placeholder="e.g., 4500">
        </div>
        <div class="form-group">
          <label>Property Type *</label>
          <select id="newBudgetPropertyType" required>
            <option value="residential">Residential (Single Family)</option>
            <option value="condo">Condo / Multi-Family</option>
          </select>
        </div>
        <div style="display:flex;gap:12px;margin-top:24px;">
          <button type="submit" class="btn btn-primary" style="flex:1;">Create Budget</button>
          <button type="button" class="btn btn-secondary" onclick="closeNewBudgetModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- CUSTOMIZE MODAL -->
<div class="modal-overlay" id="customizeModal">
  <div class="modal" style="max-width: 900px; max-height: 90vh;">
    <div class="modal-header">
      <h2>‚öôÔ∏è Customize Budget: <span id="customizeTitle"></span></h2>
      <button class="modal-close" onclick="closeCustomizeModal()">√ó</button>
    </div>
    <div class="modal-body" id="customizeBody" style="overflow-y:auto; max-height: calc(90vh - 140px);">
      <!-- Content loaded dynamically -->
    </div>
  </div>
</div>

<!-- USER MODAL -->
<div class="modal-overlay" id="userModal">
  <div class="modal" style="max-width: 450px;">
    <div class="modal-header">
      <h2 id="userModalTitle">Add User</h2>
      <button class="modal-close" onclick="closeUserModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form onsubmit="handleUserSubmit(event)">
        <input type="hidden" id="userEditId">
        <div class="form-group">
          <label>Email (used as login)</label>
          <input type="email" id="userUsername" required autocomplete="off" placeholder="user@company.com">
          <small style="color:var(--text-light);font-size:12px;">Must be a valid email address</small>
        </div>
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="userName" required autocomplete="off" placeholder="Full name">
        </div>
        <div class="form-group">
          <label id="passwordLabel">Password</label>
          <input type="password" id="userPassword" autocomplete="new-password">
          <small id="passwordHint" style="color:var(--text-light);font-size:12px;display:none;">Leave blank to keep current password</small>
        </div>
        <div style="display:flex;gap:12px;margin-top:24px;">
          <button type="submit" class="btn btn-primary" style="flex:1;">Save User</button>
          <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- BUDGET DETAIL MODAL -->
<div class="modal-overlay" id="budgetModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">Budget Details</h2>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Content loaded dynamically -->
    </div>
  </div>
</div>

<!-- FEATURES EDITOR MODAL -->
<div class="modal-overlay" id="featuresModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2>‚úèÔ∏è Edit Features: <span id="featuresTitle"></span></h2>
      <button class="modal-close" onclick="closeFeaturesModal()">√ó</button>
    </div>
    <div class="modal-body" id="featuresBody">
      <!-- Content loaded dynamically -->
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// BASE PATH DETECTION (for reverse proxy / Tailscale serve)
// ============================================================
const BASE_PATH = (() => {
  // Detect if we're behind a path prefix (e.g., /budget-dev)
  const path = window.location.pathname;
  const adminIndex = path.indexOf('/admin');
  if (adminIndex > 0) {
    return path.substring(0, adminIndex);
  }
  return '';
})();

function api(endpoint) {
  return BASE_PATH + endpoint;
}

// ============================================================
// PRICE SCALING (same formula as frontend)
// ============================================================
function getSizeMultiplier(sqft, scaleFactor) {
  // Baseline: 4000 sq ft = 1.0
  // Minimum: 2500 sq ft (smaller homes use 2500 for calculations)
  if (scaleFactor === 0) return 1;
  const effectiveSqft = Math.max(sqft, 2500);
  const baseline = 4000;
  const ratio = effectiveSqft / baseline;
  return 1 + (ratio - 1) * scaleFactor;
}

function getScaledPrice(basePrice, sqft, scaleFactor) {
  const mult = getSizeMultiplier(sqft, scaleFactor);
  return Math.round(basePrice * mult / 100) * 100;
}

// ============================================================
// STATE
// ============================================================
let currentUser = null;
let budgets = [];

// ============================================================
// INIT
// ============================================================
async function init() {
  // Check if this is a password reset link
  if (checkResetToken()) return;
  
  // Check auth status
  const res = await fetch(api('/api/auth/me'), { credentials: 'include' });
  const data = await res.json();
  
  if (data.authenticated) {
    currentUser = data.user;
    showDashboard();
  } else {
    showLogin();
  }
}

function showLogin() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('dashboard').classList.remove('active');
}

function showDashboard() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboard').classList.add('active');
  document.getElementById('userInfo').textContent = `üë§ ${currentUser.name}`;
  loadBudgets();
  loadUsers();
}

// ============================================================
// AUTH
// ============================================================
async function handleLogin(e) {
  e.preventDefault();
  
  const email = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  const errorEl = document.getElementById('loginError');
  
  try {
    const res = await fetch(api('/api/auth/login'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email, password })
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      currentUser = data.user;
      errorEl.style.display = 'none';
      showDashboard();
    } else {
      errorEl.textContent = data.error || 'Login failed';
      errorEl.style.display = 'block';
    }
  } catch (err) {
    errorEl.textContent = 'Connection error. Please try again.';
    errorEl.style.display = 'block';
  }
}

async function logout() {
  await fetch(api('/api/auth/logout'), { method: 'POST', credentials: 'include' });
  currentUser = null;
  showLogin();
}

// ============================================================
// PASSWORD RESET
// ============================================================
function showForgotPassword(e) {
  if (e) e.preventDefault();
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('forgotView').style.display = 'block';
  document.getElementById('resetView').style.display = 'none';
  document.getElementById('forgotError').style.display = 'none';
  document.getElementById('forgotSuccess').style.display = 'none';
  document.getElementById('forgotEmail').focus();
}

function showLoginView(e) {
  if (e) e.preventDefault();
  document.getElementById('loginView').style.display = 'block';
  document.getElementById('forgotView').style.display = 'none';
  document.getElementById('resetView').style.display = 'none';
  // Clear hash
  history.replaceState(null, '', window.location.pathname);
}

function showResetView() {
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('forgotView').style.display = 'none';
  document.getElementById('resetView').style.display = 'block';
  document.getElementById('resetError').style.display = 'none';
  document.getElementById('resetSuccess').style.display = 'none';
  document.getElementById('resetPassword').focus();
}

async function handleForgotPassword(e) {
  e.preventDefault();
  const email = document.getElementById('forgotEmail').value.trim();
  const errorEl = document.getElementById('forgotError');
  const successEl = document.getElementById('forgotSuccess');
  const btn = document.getElementById('forgotSubmitBtn');
  
  // Client-side email validation
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    errorEl.textContent = 'Please enter a valid email address.';
    errorEl.style.display = 'block';
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Sending...';
  errorEl.style.display = 'none';
  
  try {
    const res = await fetch(api('/api/auth/forgot-password'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      successEl.textContent = '‚úì If an account with that email exists, a reset link has been sent. Check your inbox (and spam folder).';
      successEl.style.display = 'block';
      btn.textContent = 'Email Sent';
    } else {
      errorEl.textContent = data.error || 'Something went wrong.';
      errorEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'Send Reset Link';
    }
  } catch (err) {
    errorEl.textContent = 'Connection error. Please try again.';
    errorEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Send Reset Link';
  }
}

async function handleResetPassword(e) {
  e.preventDefault();
  const password = document.getElementById('resetPassword').value;
  const confirm = document.getElementById('resetPasswordConfirm').value;
  const errorEl = document.getElementById('resetError');
  const successEl = document.getElementById('resetSuccess');
  const btn = document.getElementById('resetSubmitBtn');
  
  // Validations
  if (password.length < 8) {
    errorEl.textContent = 'Password must be at least 8 characters.';
    errorEl.style.display = 'block';
    return;
  }
  
  if (password !== confirm) {
    errorEl.textContent = 'Passwords do not match.';
    errorEl.style.display = 'block';
    return;
  }
  
  // Extract token from URL hash
  const hash = window.location.hash;
  const tokenMatch = hash.match(/token=([a-f0-9]+)/);
  if (!tokenMatch) {
    errorEl.textContent = 'Invalid reset link. Please request a new one.';
    errorEl.style.display = 'block';
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Updating...';
  errorEl.style.display = 'none';
  
  try {
    const res = await fetch(api('/api/auth/reset-password-with-token'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: tokenMatch[1], password })
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      successEl.textContent = '‚úì Password updated successfully! Redirecting to sign in...';
      successEl.style.display = 'block';
      btn.style.display = 'none';
      // Clear hash and redirect to login after 2 seconds
      setTimeout(() => {
        history.replaceState(null, '', window.location.pathname);
        showLoginView();
      }, 2000);
    } else {
      errorEl.textContent = data.error || 'Reset failed. The link may have expired.';
      errorEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'Set New Password';
    }
  } catch (err) {
    errorEl.textContent = 'Connection error. Please try again.';
    errorEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Set New Password';
  }
}

// Password strength indicator
document.addEventListener('DOMContentLoaded', () => {
  const pwField = document.getElementById('resetPassword');
  if (pwField) {
    pwField.addEventListener('input', () => {
      const pw = pwField.value;
      const el = document.getElementById('passwordStrength');
      if (!pw) { el.innerHTML = ''; return; }
      
      let score = 0;
      if (pw.length >= 8) score++;
      if (pw.length >= 12) score++;
      if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
      if (/\d/.test(pw)) score++;
      if (/[^A-Za-z0-9]/.test(pw)) score++;
      
      const labels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
      const colors = ['#D32F2F', '#F57C00', '#FFC107', '#4CAF50', '#2E7D32'];
      const idx = Math.min(score, 4);
      
      el.innerHTML = `<span style="color:${colors[idx]}">‚óè</span> ${labels[idx]}`;
    });
  }
});

// Check for reset token in URL hash on page load
function checkResetToken() {
  const hash = window.location.hash;
  if (hash.startsWith('#reset-password') && hash.includes('token=')) {
    document.getElementById('loginPage').style.display = 'flex';
    showResetView();
    return true;
  }
  return false;
}

// ============================================================
// BUDGETS
// ============================================================
async function loadBudgets() {
  try {
    const res = await fetch(api('/api/admin/budgets'), { credentials: 'include' });
    if (res.status === 401) {
      showLogin();
      return;
    }
    
    budgets = await res.json();
    renderBudgets();
    updateStats();
  } catch (err) {
    console.error('Load budgets error:', err);
    showToast('Failed to load budgets');
  }
}

function renderBudgets() {
  const tbody = document.getElementById('budgetTableBody');
  
  if (budgets.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="empty-state">
          <p>No budgets yet</p>
          <p style="font-size:13px;">Budgets will appear here when clients use the Share Link button</p>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = budgets.map(b => `
    <tr>
      <td>
        <a href="${BASE_PATH}/b/${b.id}" target="_blank" class="budget-link">
          ${b.clientName || 'Unnamed'} 
        </a>
        <div style="font-size:11px;color:var(--text-light);">
          ${b.id}
          ${b.builder ? ` ‚Ä¢ ${b.builder}` : ''}
          ${b.isCustomized ? ' <span style="color:#F57C00;">‚öôÔ∏è Custom</span>' : ''}
        </div>
      </td>
      <td><strong>${formatCurrency(b.currentTotal)}</strong></td>
      <td>${formatDate(b.created)}</td>
      <td><span class="badge badge-views">${b.viewCount} ${b.viewCount === 1 ? 'view' : 'views'}</span></td>
      <td><span class="badge badge-versions">${b.versionCount} versions</span></td>
      <td>${b.lastViewed ? formatRelative(b.lastViewed) : 'Never'}</td>
      <td class="actions-cell">
        <button class="btn btn-secondary btn-small" onclick="viewBudget('${b.id}')">Details</button>
        <button class="btn btn-small" style="background:#E3F2FD;color:#1565C0;" onclick="openCustomizeModal('${b.id}')">‚öôÔ∏è</button>
        <button class="btn btn-small" style="background:#FFF3E0;color:#E65100;" onclick="deleteBudget('${b.id}')">üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

function updateStats() {
  const totalBudgets = budgets.length;
  const totalViews = budgets.reduce((sum, b) => sum + (b.viewCount || 0), 0);
  const totalValue = budgets.reduce((sum, b) => sum + (b.currentTotal || 0), 0);
  
  // Count budgets created this week
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  const weekBudgets = budgets.filter(b => new Date(b.created) > oneWeekAgo).length;
  
  document.getElementById('statTotalBudgets').textContent = totalBudgets;
  document.getElementById('statTotalViews').textContent = totalViews;
  document.getElementById('statWeekBudgets').textContent = weekBudgets;
  document.getElementById('statTotalValue').textContent = formatCurrency(totalValue);
}

async function viewBudget(id) {
  try {
    const res = await fetch(api(`/api/admin/budgets/${id}`), { credentials: 'include' });
    if (!res.ok) throw new Error('Failed to load budget');
    
    const budget = await res.json();
    showBudgetModal(budget);
  } catch (err) {
    console.error('View budget error:', err);
    showToast('Failed to load budget details');
  }
}

function showBudgetModal(budget) {
  document.getElementById('modalTitle').textContent = budget.clientName || 'Unnamed Budget';
  
  const body = document.getElementById('modalBody');
  body.innerHTML = `
    <div class="detail-grid">
      <div class="detail-item">
        <div class="label">Budget ID</div>
        <div class="value">${budget.id}</div>
      </div>
      <div class="detail-item">
        <div class="label">Current Total</div>
        <div class="value">${formatCurrency(budget.currentState?.total || 0)}</div>
      </div>
      <div class="detail-item">
        <div class="label">Created</div>
        <div class="value">${formatDate(budget.created)}</div>
      </div>
      <div class="detail-item">
        <div class="label">Last Modified</div>
        <div class="value">${formatRelative(budget.lastModified)}</div>
      </div>
      <div class="detail-item">
        <div class="label">Total Views</div>
        <div class="value">${budget.views?.length || 0}</div>
      </div>
      <div class="detail-item">
        <div class="label">Total Versions</div>
        <div class="value">${budget.versions?.length || 0}</div>
      </div>
    </div>
    
    <div class="section-title">üìç View History (${budget.views?.length || 0})</div>
    <div class="views-list">
      ${(budget.views && budget.views.length > 0) ? 
        budget.views.slice().reverse().map(v => `
          <div class="view-item">
            <span>${formatDateTime(v.timestamp)}</span>
            <span style="color:var(--text-light);font-size:11px;">${v.userAgent?.split(' ')[0] || 'Unknown device'}</span>
          </div>
        `).join('') : 
        '<div style="color:var(--text-light);text-align:center;padding:12px;">No views yet</div>'
      }
    </div>
    
    <div class="section-title">üìú Version History (${budget.versions?.length || 0})</div>
    <div class="versions-list">
      ${(budget.versions && budget.versions.length > 0) ? 
        budget.versions.slice().reverse().map(v => `
          <div class="version-item" style="${v.pinned ? 'background:#FFF8E1;' : ''}">
            <div class="version-info">
              <span class="version-num">v${v.version}</span>
              ${v.pinned ? '<span style="color:#F57C00;font-size:11px;margin-left:4px;">üìå</span>' : '<span style="color:#9E9E9E;font-size:10px;margin-left:4px;">(auto)</span>'}
              ‚Äî <span>${formatDateTime(v.timestamp)}</span>
              <div class="version-note">${v.note || 'No note'} ‚Ä¢ ${formatCurrency(v.state?.total || 0)}</div>
            </div>
            ${v.version < budget.versions.length ? `
              <button class="btn btn-secondary btn-small" onclick="restoreVersion('${budget.id}', ${v.version})">Restore</button>
            ` : '<span style="color:var(--success);font-size:12px;">Current</span>'}
          </div>
        `).join('') : 
        '<div style="color:var(--text-light);text-align:center;padding:12px;">No versions</div>'
      }
    </div>
    
    <div style="display:flex;gap:12px;margin-top:20px;">
      <a href="${BASE_PATH}/b/${budget.id}" target="_blank" class="btn btn-primary" style="text-decoration:none;text-align:center;">Open Budget</a>
      <button class="btn btn-secondary" onclick="copyBudgetLink('${budget.id}')">Copy Link</button>
    </div>
  `;
  
  document.getElementById('budgetModal').classList.add('active');
}

function closeModal() {
  document.getElementById('budgetModal').classList.remove('active');
}

async function restoreVersion(budgetId, version) {
  if (!confirm(`Restore to version ${version}? This will create a new version with the old state.`)) return;
  
  try {
    const res = await fetch(api(`/api/admin/budgets/${budgetId}/restore/${version}`), {
      method: 'POST'
    });
    
    if (!res.ok) throw new Error('Failed to restore');
    
    showToast('‚úì Version restored');
    closeModal();
    loadBudgets();
    
    // Reopen modal with fresh data
    setTimeout(() => viewBudget(budgetId), 500);
  } catch (err) {
    console.error('Restore error:', err);
    showToast('Failed to restore version');
  }
}

async function deleteBudget(id) {
  const budget = budgets.find(b => b.id === id);
  const name = budget?.clientName || id;
  
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  
  try {
    const res = await fetch(api(`/api/admin/budgets/${id}`), { method: 'DELETE' });
    if (!res.ok) throw new Error('Failed to delete');
    
    showToast('‚úì Budget deleted');
    loadBudgets();
  } catch (err) {
    console.error('Delete error:', err);
    showToast('Failed to delete budget');
  }
}

function copyBudgetLink(id) {
  const url = window.location.origin + BASE_PATH + '/b/' + id;
  navigator.clipboard.writeText(url).then(() => {
    showToast('üîó Link copied!');
  }).catch(() => {
    showToast('Failed to copy');
  });
}

// ============================================================
// NEW BUDGET
// ============================================================

function showNewBudgetModal() {
  document.getElementById('newBudgetClient').value = '';
  document.getElementById('newBudgetBuilder').value = '';
  document.getElementById('newBudgetSqft').value = '';
  document.getElementById('newBudgetPropertyType').value = 'residential';
  document.getElementById('newBudgetModal').classList.add('active');
  document.getElementById('newBudgetClient').focus();
}

function closeNewBudgetModal() {
  document.getElementById('newBudgetModal').classList.remove('active');
}

async function handleNewBudgetSubmit(e) {
  e.preventDefault();
  
  const clientName = document.getElementById('newBudgetClient').value.trim();
  const builder = document.getElementById('newBudgetBuilder').value.trim();
  const homeSize = parseInt(document.getElementById('newBudgetSqft').value);
  const propertyType = document.getElementById('newBudgetPropertyType').value;
  
  try {
    const res = await fetch(api('/api/admin/budgets'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ clientName, builder, homeSize, propertyType })
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      showToast('‚úì Budget created');
      closeNewBudgetModal();
      loadBudgets();
      // Open customize modal for the new budget
      setTimeout(() => openCustomizeModal(data.id), 500);
    } else {
      showToast('‚ùå ' + (data.error || 'Failed to create budget'));
    }
  } catch (err) {
    console.error('Create budget error:', err);
    showToast('Failed to create budget');
  }
}

// ============================================================
// CUSTOMIZE BUDGET
// ============================================================

let customizeBudgetId = null;
let customizeBudgetData = null;

async function openCustomizeModal(budgetId) {
  customizeBudgetId = budgetId;
  
  try {
    // Load full budget details
    const res = await fetch(api(`/api/admin/budgets/${budgetId}`), { credentials: 'include' });
    if (!res.ok) throw new Error('Failed to load budget');
    customizeBudgetData = await res.json();
    
    document.getElementById('customizeTitle').textContent = customizeBudgetData.clientName || budgetId;
    
    renderCustomizeEditor();
    document.getElementById('customizeModal').classList.add('active');
  } catch (err) {
    console.error('Load budget error:', err);
    showToast('Failed to load budget');
  }
}

function closeCustomizeModal() {
  document.getElementById('customizeModal').classList.remove('active');
  customizeBudgetId = null;
  customizeBudgetData = null;
}

function renderCustomizeEditor() {
  const body = document.getElementById('customizeBody');
  const budget = customizeBudgetData;
  const sqft = budget.sqftLocked || budget.currentState?.homeSize || 4000;
  const propertyType = budget.propertyTypeLocked || budget.currentState?.propertyType || 'residential';
  const selections = budget.currentState?.selections || {};
  const existingConfig = budget.categoryConfig || {};
  const existingCustom = budget.customCategories || [];
  
  // Get default categories from frontend (we'll need to embed these)
  const defaultCategories = getDefaultCategories(propertyType);
  
  body.innerHTML = `
    <div style="background:#FFF8E1;padding:12px 16px;border-radius:8px;margin-bottom:20px;font-size:14px;">
      <strong>‚ö†Ô∏è Customization Info:</strong><br>
      ‚Ä¢ Sqft locked at: <strong>${sqft.toLocaleString()}</strong><br>
      ‚Ä¢ Property type: <strong>${propertyType}</strong><br>
      ‚Ä¢ Saving will ${budget.isCustomized ? 'update' : 'lock sqft and wipe all'} versions
    </div>
    
    <div id="categoryEditors" data-sqft="${sqft}">
      ${defaultCategories.map(cat => renderCategoryEditor(cat, existingConfig[cat.id], selections[cat.id], sqft)).join('')}
    </div>
    
    <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
      <h3 style="margin-bottom:12px;">‚ûï Custom Categories</h3>
      <div id="customCategoriesList">
        ${existingCustom.map((cc, i) => renderCustomCategoryEditor(cc, i, selections[cc.id])).join('')}
      </div>
      <button type="button" class="btn btn-secondary btn-small" onclick="addCustomCategory()" style="margin-top:12px;">+ Add Custom Category</button>
    </div>
    
    <div style="display:flex;gap:12px;margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
      <button class="btn btn-primary" onclick="saveCustomization()" style="flex:1;">üíæ Save Customization</button>
      <button class="btn btn-secondary" onclick="closeCustomizeModal()">Cancel</button>
    </div>
  `;
}

function renderCategoryEditor(cat, existingOverride, selectedTier, sqft) {
  const override = existingOverride || {};
  const isHidden = override.hidden === true;
  const isLocked = selectedTier && !isHidden; // Can't hide if selected
  const sizeScale = cat.sizeScale ?? 0.5; // Default scale factor
  
  // All possible tiers - show all of them, even if missing from base data
  const allTiers = ['good', 'standard', 'better', 'best'];
  const tierLabels = { good: 'Good', standard: 'Standard', better: 'Better', best: 'Best' };
  
  return `
    <div class="category-editor" data-cat-id="${cat.id}" data-size-scale="${sizeScale}" style="margin-bottom:16px;padding:16px;background:var(--bg);border-radius:8px;${isHidden ? 'opacity:0.6;' : ''}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div>
          <strong>${cat.icon} ${cat.name}</strong>
          ${selectedTier ? `<span style="color:var(--accent);font-size:12px;margin-left:8px;">‚óè ${selectedTier} selected</span>` : ''}
        </div>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;${isLocked ? 'opacity:0.5;' : ''}">
          <input type="checkbox" 
            ${isHidden ? '' : 'checked'} 
            ${isLocked ? 'disabled' : ''} 
            onchange="toggleCategoryHidden('${cat.id}', !this.checked)"
          > Show
        </label>
      </div>
      <div class="tier-editors" style="display:${isHidden ? 'none' : 'grid'};gap:8px;">
        ${allTiers.map(tierKey => {
          const defaultTier = cat.tiers[tierKey];
          const tierOverride = override.tiers?.[tierKey] || {};
          const existsInBase = !!defaultTier;
          
          // For tiers that exist in base: enabled by default unless explicitly disabled
          // For tiers that DON'T exist: disabled by default unless explicitly enabled
          const isEnabled = existsInBase 
            ? (tierOverride.enabled !== false)
            : (tierOverride.enabled === true);
          
          const isTierLocked = selectedTier === tierKey;
          
          // Get base price and scale it for sqft
          const basePrice = defaultTier?.price || 0;
          const tierSizeScale = defaultTier?.sizeScale ?? sizeScale;
          const scaledPrice = basePrice ? getScaledPrice(basePrice, sqft, tierSizeScale) : 0;
          
          // Use override price if set, otherwise use scaled price
          const price = tierOverride.price ?? scaledPrice;
          const label = tierOverride.label ?? (defaultTier?.label || tierLabels[tierKey]);
          
          // Get features for data attribute (for features editor)
          const features = tierOverride.features ?? (defaultTier?.features || []);
          const brands = tierOverride.brands ?? (defaultTier?.brands || '');
          
          return `
            <div class="tier-row" data-tier="${tierKey}" 
                 data-has-base="${existsInBase}" 
                 data-base-price="${basePrice}"
                 data-scaled-price="${scaledPrice}"
                 data-features='${JSON.stringify(features).replace(/'/g, "&#39;")}'
                 data-brands="${brands.replace(/"/g, '&quot;')}"
                 style="display:flex;gap:8px;align-items:center;padding:8px;background:${existsInBase ? 'white' : '#FFF3E0'};border-radius:6px;${!isEnabled ? 'opacity:0.5;' : ''}${!existsInBase ? 'border:1px dashed #FFB74D;' : ''}">
              <label style="width:70px;display:flex;align-items:center;gap:4px;${isTierLocked ? 'opacity:0.5;' : ''}">
                <input type="checkbox" class="tier-enabled" 
                  ${isEnabled ? 'checked' : ''} 
                  ${isTierLocked ? 'disabled title="Tier is selected"' : ''}
                  onchange="toggleTierEnabled('${cat.id}', '${tierKey}', this.checked)"
                > ${tierLabels[tierKey]}
              </label>
              <input type="text" class="tier-label" value="${label}" placeholder="Label" style="flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px;" ${!isEnabled ? 'disabled' : ''}>
              <div style="position:relative;">
                <input type="number" class="tier-price" value="${price}" placeholder="Price" style="width:110px;padding:6px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px;" ${!isEnabled ? 'disabled' : ''}>
                ${existsInBase && scaledPrice ? `<span style="position:absolute;right:4px;top:-8px;font-size:10px;color:var(--text-light);">base: $${scaledPrice.toLocaleString()}</span>` : ''}
              </div>
              <button type="button" class="btn btn-secondary btn-small" onclick="editTierFeatures('${cat.id}', '${tierKey}')" ${!isEnabled ? 'disabled' : ''}>Features</button>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function renderCustomCategoryEditor(cc, index, selectedTier) {
  const isLocked = !!selectedTier;
  const allTiers = ['good', 'standard', 'better', 'best'];
  const tierLabels = { good: 'Good', standard: 'Standard', better: 'Better', best: 'Best' };
  
  return `
    <div class="custom-category-editor" data-index="${index}" data-cc-id="${cc.id || ''}" style="margin-bottom:16px;padding:16px;background:#E3F2FD;border-radius:8px;">
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input type="text" class="cc-icon" value="${cc.icon || 'üì¶'}" style="width:50px;padding:6px;border:1px solid var(--border);border-radius:4px;text-align:center;font-size:18px;">
        <input type="text" class="cc-name" value="${cc.name || ''}" placeholder="Category Name" style="flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:4px;">
        <button type="button" class="btn btn-small" style="background:#FFEBEE;color:#C62828;" onclick="removeCustomCategory(${index})" ${isLocked ? 'disabled title="Has selection"' : ''}>Remove</button>
      </div>
      <div class="cc-tiers" style="display:grid;gap:8px;">
        ${allTiers.map(tierKey => {
          const tier = cc.tiers?.[tierKey] || {};
          const isTierLocked = selectedTier === tierKey;
          const isEnabled = tier.enabled !== false && (tier.label || tier.price);
          const features = tier.features || [];
          const brands = tier.brands || '';
          
          return `
            <div class="cc-tier-row" data-tier="${tierKey}" 
                 data-features='${JSON.stringify(features).replace(/'/g, "&#39;")}'
                 data-brands="${(brands || '').replace(/"/g, '&quot;')}"
                 style="display:flex;gap:8px;align-items:center;padding:8px;background:white;border-radius:6px;${!isEnabled && !isTierLocked ? 'opacity:0.5;' : ''}">
              <label style="width:70px;display:flex;align-items:center;gap:4px;${isTierLocked ? 'opacity:0.5;' : ''}">
                <input type="checkbox" class="cc-tier-enabled" 
                  ${isEnabled || isTierLocked ? 'checked' : ''} 
                  ${isTierLocked ? 'disabled title="Tier is selected"' : ''}
                  onchange="toggleCustomTierEnabled(${index}, '${tierKey}', this.checked)"
                > ${tierLabels[tierKey]}
              </label>
              <input type="text" class="cc-tier-label" data-tier="${tierKey}" value="${tier.label || ''}" placeholder="Label" style="flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px;" ${!isEnabled && !isTierLocked ? 'disabled' : ''}>
              <input type="number" class="cc-tier-price" data-tier="${tierKey}" value="${tier.price || ''}" placeholder="Price" style="width:100px;padding:6px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px;" ${!isEnabled && !isTierLocked ? 'disabled' : ''}>
              <button type="button" class="btn btn-secondary btn-small" onclick="editCustomTierFeatures(${index}, '${tierKey}')" ${!isEnabled && !isTierLocked ? 'disabled' : ''}>Features</button>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function toggleCustomTierEnabled(index, tierKey, enabled) {
  const editor = document.querySelector(`.custom-category-editor[data-index="${index}"]`);
  if (editor) {
    const tierRow = editor.querySelector(`.cc-tier-row[data-tier="${tierKey}"]`);
    if (tierRow) {
      tierRow.style.opacity = enabled ? '1' : '0.5';
      tierRow.querySelectorAll('input:not(.cc-tier-enabled), button').forEach(el => el.disabled = !enabled);
    }
  }
}

function editCustomTierFeatures(index, tierKey) {
  featureEditorCatId = `custom-${index}`;
  featureEditorTierKey = tierKey;
  
  const editor = document.querySelector(`.custom-category-editor[data-index="${index}"]`);
  const tierRow = editor?.querySelector(`.cc-tier-row[data-tier="${tierKey}"]`);
  
  if (!tierRow) {
    showToast('Could not find tier data');
    return;
  }
  
  let features = [];
  try {
    features = JSON.parse(tierRow.dataset.features || '[]');
  } catch (e) {
    features = [];
  }
  const brands = tierRow.dataset.brands || '';
  const label = tierRow.querySelector('.cc-tier-label').value || tierKey;
  const catName = editor.querySelector('.cc-name').value || 'Custom Category';
  
  document.getElementById('featuresTitle').textContent = `${catName} ‚Üí ${label}`;
  
  document.getElementById('featuresBody').innerHTML = `
    <div style="margin-bottom:20px;">
      <label style="font-weight:600;display:block;margin-bottom:8px;">Features (one per line)</label>
      <textarea id="featuresTextarea" style="width:100%;height:200px;padding:12px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:14px;resize:vertical;">${features.join('\n')}</textarea>
    </div>
    
    <div style="margin-bottom:20px;">
      <label style="font-weight:600;display:block;margin-bottom:8px;">Typical Brands</label>
      <input type="text" id="brandsInput" value="${brands}" placeholder="e.g., Sonos, Control4, Lutron" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
    </div>
    
    <div style="display:flex;gap:12px;">
      <button class="btn btn-primary" onclick="saveCustomTierFeatures(${index}, '${tierKey}')" style="flex:1;">Save Features</button>
      <button class="btn btn-secondary" onclick="closeFeaturesModal()">Cancel</button>
    </div>
  `;
  
  document.getElementById('featuresModal').classList.add('active');
}

function saveCustomTierFeatures(index, tierKey) {
  const textarea = document.getElementById('featuresTextarea');
  const brandsInput = document.getElementById('brandsInput');
  
  const features = textarea.value.split('\n')
    .map(f => f.trim())
    .filter(f => f.length > 0);
  
  const brands = brandsInput.value.trim();
  
  const editor = document.querySelector(`.custom-category-editor[data-index="${index}"]`);
  const tierRow = editor?.querySelector(`.cc-tier-row[data-tier="${tierKey}"]`);
  
  if (tierRow) {
    tierRow.dataset.features = JSON.stringify(features);
    tierRow.dataset.brands = brands;
  }
  
  closeFeaturesModal();
  showToast('‚úì Features updated');
}

function toggleCategoryHidden(catId, hidden) {
  const editor = document.querySelector(`.category-editor[data-cat-id="${catId}"]`);
  if (editor) {
    editor.style.opacity = hidden ? '0.6' : '1';
    editor.querySelector('.tier-editors').style.display = hidden ? 'none' : 'grid';
  }
}

function toggleTierEnabled(catId, tierKey, enabled) {
  const editor = document.querySelector(`.category-editor[data-cat-id="${catId}"]`);
  if (editor) {
    const tierRow = editor.querySelector(`.tier-row[data-tier="${tierKey}"]`);
    if (tierRow) {
      tierRow.style.opacity = enabled ? '1' : '0.5';
      tierRow.querySelectorAll('input:not(.tier-enabled), button').forEach(el => el.disabled = !enabled);
    }
  }
}

// ============================================================
// FEATURES EDITOR
// ============================================================
let featureEditorCatId = null;
let featureEditorTierKey = null;

function editTierFeatures(catId, tierKey) {
  featureEditorCatId = catId;
  featureEditorTierKey = tierKey;
  
  // Find the tier row to get current data
  const editor = document.querySelector(`.category-editor[data-cat-id="${catId}"]`);
  const tierRow = editor?.querySelector(`.tier-row[data-tier="${tierKey}"]`);
  
  if (!tierRow) {
    showToast('Could not find tier data');
    return;
  }
  
  // Parse features from data attribute
  let features = [];
  try {
    features = JSON.parse(tierRow.dataset.features || '[]');
  } catch (e) {
    features = [];
  }
  const brands = tierRow.dataset.brands || '';
  const label = tierRow.querySelector('.tier-label').value || tierKey;
  
  // Get category name for title
  const catName = editor.querySelector('strong').textContent;
  
  document.getElementById('featuresTitle').textContent = `${catName} ‚Üí ${label}`;
  
  document.getElementById('featuresBody').innerHTML = `
    <div style="margin-bottom:20px;">
      <label style="font-weight:600;display:block;margin-bottom:8px;">Features (one per line)</label>
      <textarea id="featuresTextarea" style="width:100%;height:200px;padding:12px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:14px;resize:vertical;">${features.join('\n')}</textarea>
    </div>
    
    <div style="margin-bottom:20px;">
      <label style="font-weight:600;display:block;margin-bottom:8px;">Typical Brands</label>
      <input type="text" id="brandsInput" value="${brands}" placeholder="e.g., Sonos, Control4, Lutron" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
    </div>
    
    <div style="display:flex;gap:12px;">
      <button class="btn btn-primary" onclick="saveTierFeatures()" style="flex:1;">Save Features</button>
      <button class="btn btn-secondary" onclick="closeFeaturesModal()">Cancel</button>
    </div>
  `;
  
  document.getElementById('featuresModal').classList.add('active');
}

function saveTierFeatures() {
  const textarea = document.getElementById('featuresTextarea');
  const brandsInput = document.getElementById('brandsInput');
  
  // Parse features from textarea (one per line, filter empty)
  const features = textarea.value.split('\n')
    .map(f => f.trim())
    .filter(f => f.length > 0);
  
  const brands = brandsInput.value.trim();
  
  // Update the tier row data attributes
  const editor = document.querySelector(`.category-editor[data-cat-id="${featureEditorCatId}"]`);
  const tierRow = editor?.querySelector(`.tier-row[data-tier="${featureEditorTierKey}"]`);
  
  if (tierRow) {
    tierRow.dataset.features = JSON.stringify(features);
    tierRow.dataset.brands = brands;
  }
  
  closeFeaturesModal();
  showToast('‚úì Features updated');
}

function closeFeaturesModal() {
  document.getElementById('featuresModal').classList.remove('active');
  featureEditorCatId = null;
  featureEditorTierKey = null;
}

let customCategoryCount = 0;
function addCustomCategory() {
  const list = document.getElementById('customCategoriesList');
  const index = list.children.length;
  const html = renderCustomCategoryEditor({ id: `custom-${Date.now()}`, icon: 'üì¶', name: '', tiers: {} }, index, null);
  list.insertAdjacentHTML('beforeend', html);
}

function removeCustomCategory(index) {
  const el = document.querySelector(`.custom-category-editor[data-index="${index}"]`);
  if (el) el.remove();
}

async function saveCustomization() {
  if (!customizeBudgetId) return;
  
  const categoryConfig = {};
  const customCategories = [];
  
  // Collect category overrides
  document.querySelectorAll('.category-editor').forEach(editor => {
    const catId = editor.dataset.catId;
    const showCheckbox = editor.querySelector('input[type="checkbox"]:not(.tier-enabled)');
    const isHidden = showCheckbox && !showCheckbox.checked;
    
    const tiers = {};
    editor.querySelectorAll('.tier-row').forEach(row => {
      const tierKey = row.dataset.tier;
      const enabled = row.querySelector('.tier-enabled')?.checked ?? true;
      const label = row.querySelector('.tier-label')?.value || '';
      const price = parseInt(row.querySelector('.tier-price')?.value) || 0;
      
      // Get features and brands from data attributes
      let features = [];
      try {
        features = JSON.parse(row.dataset.features || '[]');
      } catch (e) {
        features = [];
      }
      const brands = row.dataset.brands || '';
      
      tiers[tierKey] = { enabled, label, price, features, brands };
    });
    
    categoryConfig[catId] = { hidden: isHidden, tiers };
  });
  
  // Collect custom categories
  document.querySelectorAll('.custom-category-editor').forEach(editor => {
    const icon = editor.querySelector('.cc-icon')?.value || 'üì¶';
    const name = editor.querySelector('.cc-name')?.value || '';
    if (!name) return; // Skip empty custom categories
    
    const tiers = {};
    editor.querySelectorAll('.cc-tier-row').forEach(row => {
      const tierKey = row.dataset.tier;
      const enabled = row.querySelector('.cc-tier-enabled')?.checked ?? false;
      const label = row.querySelector('.cc-tier-label')?.value || '';
      const price = parseInt(row.querySelector('.cc-tier-price')?.value) || 0;
      
      // Get features and brands from data attributes
      let features = [];
      try {
        features = JSON.parse(row.dataset.features || '[]');
      } catch (e) {
        features = [];
      }
      const brands = row.dataset.brands || '';
      
      // Only include tier if enabled and has label or price
      if (enabled && (label || price)) {
        tiers[tierKey] = { enabled, label, price, features, brands };
      }
    });
    
    // Only add if at least one tier is configured
    if (Object.keys(tiers).length > 0) {
      customCategories.push({
        id: editor.dataset.ccId || `custom-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,
        name,
        icon,
        desc: '',
        tiers
      });
    }
  });
  
  // Confirm if not already customized
  if (!customizeBudgetData.isCustomized) {
    if (!confirm('This will lock sqft and wipe all previous versions. Continue?')) {
      return;
    }
  }
  
  try {
    const res = await fetch(api(`/api/admin/budgets/${customizeBudgetId}/customize`), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ categoryConfig, customCategories })
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      showToast('‚úì Customization saved');
      closeCustomizeModal();
      loadBudgets();
    } else {
      showToast('‚ùå ' + (data.error || 'Failed to save'));
      if (data.lockedTiers) {
        console.log('Locked tiers:', data.lockedTiers);
      }
    }
  } catch (err) {
    console.error('Save customization error:', err);
    showToast('Failed to save customization');
  }
}

// Default categories (subset for the editor - will be loaded from frontend config)
// ============================================================
// FULL CATEGORY DATA (matches frontend exactly for correct scaling)
// ============================================================
const ADMIN_CATEGORIES = [{"id":"prewire","section":"Infrastructure","name":"Structured Wiring & Pre-Wire","icon":"üîå","desc":"Low voltage wiring infrastructure for all technology systems","sizeScale":1,"tiers":{"good":{"price":12000,"label":"Essential","tag":"Good","features":["Dual CAT6 for TVs to main rooms, single CAT6 to others","Basic coax (RG6) to all TVs","Standard structured media panel","Speaker wire to primary living area"],"brands":"Cat6, RG6 coax, 16-4, Leviton panel"},"standard":{"price":22000,"label":"Standard","tag":"Standard","features":["Dual Cat6 to all TVs","Speaker wire to primary living area, lanai, and master bed","Camera pre-wire (front and rear basics)","Alarm pre-wire for all doors, single keypad at garage entry","Upgraded structured media panel with fiber optic incoming"],"brands":"Cat6, Single mode fiber optic, 16/4 speaker wire, Future Automation Structured Media Panel"},"better":{"price":35000,"label":"Comprehensive","tag":"Better","features":["Dual Cat6A to all TVs","Speaker wire to all living areas, lanai, kitchen, master suite, and single outdoor zone","Outside perimeter camera pre-wire","Alarm pre-wire for all doors and windows, keypads at garage entry and master bedroom","Lutron shade pre-wire to all main living area windows and master bedroom","Upgraded structured media panel with fiber optic and conduit for incoming pathway"],"brands":"Cat6A, Single mode fiber optic, 16/2 speaker wire, Lutron shade wire, Direct Burial 16/4, Future Automation Structured Media Panel"},"best":{"price":44000,"label":"Premium","tag":"Best","features":["Dual Cat6A to all TVs plus CAT7 to main rooms","Pre-wire for extensive audio zones + single Atmos room","Full outside perimeter camera pre-wire + gate/entry points","Alarm pre-wire for all doors and windows, keypads at garage entry(s) and master bedroom","Shade pre-wire to most (if not all) windows","Multiple zone outdoor landscape speaker pre-wire and conduit","Gate/intercom wiring","Guest house connectivity","Upgraded structured media panels (multiple) including fiber optic and conduit for incoming pathways"],"brands":"Cat6A, Single mode fiber optic, 16/2 speaker wire, Lutron shade wire, Direct Burial 16/4, Future Automation Structured Media Panel"}}},{"id":"networking","section":"Infrastructure","name":"Whole-Home WiFi & Networking","icon":"üì°","desc":"Enterprise-grade WiFi coverage and network infrastructure","sizeScale":0.8,"tiers":{"good":{"price":5700,"label":"Reliable, Basic Coverage","tag":"Good","features":["WiFi 7 access points for full interior coverage and lanai","Cloud managed pro router","Managed PoE switch","App-managed, remote access"],"brands":"UniFi LR, USW-Pro-24-PoE"},"better":{"price":9700,"label":"Full Coverage","tag":"Better","features":["WiFi 7 access points for full interior, lanai, and garage(s)","Cloud managed pro router","Managed pro series PoE+ switches with 10G uplinks","UPS backup for short power outages","App-managed, remote access"],"brands":"UniFi Pro, Unifi UPS, UDM Pro"},"best":{"price":15000,"label":"Enterprise Class","tag":"Best","features":["High capacity WiFi 7 access points for full interior, lanai, and garage(s)","Cloud managed pro router with support for multiple internet connections","Managed enterprise series PoE+ switches with 10G uplinks","UPS backup for short power outages","App-managed, remote access"],"brands":"UniFi Enterprise, Unifi UPS, UDM Pro"}}},{"id":"surveillance","section":"Security","name":"Surveillance & Security Cameras","icon":"üìπ","desc":"IP camera system with recording and smart detection","sizeScale":0.7,"baseTierNoScale":true,"tiers":{"good":{"price":5300,"label":"Key Coverage","tag":"Good","features":["Basic front and rear exterior coverage","4K cameras","14 day recording retention","Motion alerts to phone","Night vision & weather-rated"],"brands":"UniFi"},"better":{"price":10700,"label":"Enhanced Coverage","tag":"Better","features":["Exterior entry points covered including front and rear","4K enhanced cameras with AI detection","21-day recording retention","Integration for viewing on TVs","Marine-grade outdoor housings"],"brands":"UniFi Pro Series"},"best":{"price":19300,"label":"Full Perimeter","tag":"Best","features":["Full perimeter coverage","AI searching and analytics (person/vehicle/animal)","21-day recording","Interior camera for garage(s)","Control4/Crestron integration"],"brands":"UniFi Pro Series, Cloud Key"}}},{"id":"audio","section":"Audio","name":"Multi-Room Audio","icon":"üîä","desc":"Whole-home distributed audio ‚Äî indoor and outdoor zones","sizeScale":0.7,"tiers":{"good":{"price":9600,"label":"Basic","tag":"Good","features":["Main living areas with music","Basic outdoor in ceiling zone","Architectural in-ceiling speakers","App-controlled music","AirPlay 2 & all streaming services"],"brands":"Sonos Amp, Sonos Architectural by Sonance, Control4, Crestron"},"standard":{"price":18000,"label":"Standard","tag":"Standard","features":["Main living areas, kitchen and master suite with music","Outdoor in-ceiling audio zone(s)","Upgraded in ceiling speakers","Automation system integration"],"brands":"Sonos Amp, Sonos Architectural by Sonance, Control4, Crestron, Sonance"},"better":{"price":27000,"label":"Entertainment Focused","tag":"Better","features":["Main living areas, kitchen, guest area(s), and master suite with music","Outdoor in-ceiling audio zone(s)","More speakers in living areas to eliminate loud spots during entertaining","Premium in-ceiling speakers","Automation system integration"],"brands":"Sonos Amp, Sonos Architectural by Sonance, Control4, Crestron"},"best":{"price":32000,"label":"Music Lover","tag":"Best","features":["Main living areas, kitchen, guest area(s), and master suite with music","Outdoor in-ceiling audio zone(s)","Ultra Premium in-ceiling speakers in main listening areas","In ceiling/in wall subwoofer(s) in main listening area(s)","Automation system integration"],"brands":"Sonos Amp, Sonos Architectural by Sonance, Control4, Crestron, Monitor Audio, Sonance, B&W"}}},{"id":"invisible-speakers","section":"Audio","name":"Invisible Speakers","icon":"ü™Ñ","desc":"For those who want the cleanest design ‚Äî speakers completely hidden behind drywall","sizeScale":0.5,"tiers":{"good":{"price":7500,"sizeScale":0.2,"label":"Key Coverage","tag":"Good","features":["Key area(s) provided with invisible speakers"],"brands":"Amina Loudspeakers, Stealth Acoustics"},"standard":{"price":10500,"sizeScale":0.3,"label":"Main Living","tag":"Standard","features":["Main living area(s) including kitchen or other key area(s) provided with invisible speakers"],"brands":"Amina Loudspeakers, Stealth Acoustics"},"better":{"price":28500,"sizeScale":0.5,"label":"Whole Home","tag":"Better","features":["Replace all interior speakers with invisible speakers"],"brands":"Amina Loudspeakers, Stealth Acoustics"},"best":{"price":38500,"sizeScale":0.6,"label":"Whole Home, Premium","tag":"Best","features":["Replace all interior speakers with premium invisible speakers","Invisible subwoofers installed in key areas"],"brands":"Amina Loudspeakers, Stealth Acoustics"}}},{"id":"surround","section":"Audio","name":"Surround Sound","icon":"üîâ","desc":"Immersive surround audio for your main TV without a dedicated theater room","sizeScale":0,"tiers":{"good":{"price":5300,"label":"Sonos Surround","tag":"Good","features":["Sonos Arc Ultra Soundbar wall mounted","2 Sonos in-ceiling speakers","Sonos Sub","Apple TV 4K source","Behind TV box for video sources"],"brands":"Sonos, Apple TV 4K"},"better":{"price":9900,"label":"Custom Surround","tag":"Better","features":["Soundbar custom made to match TV width","4 in-ceiling speakers for Atmos and Surround","Single in-wall subwoofer","Atmos Surround Amplifier","Apple TV 4K source","Large behind TV box for local components"],"brands":"Sony AVR, Sonance, Leon, Apple TV 4K, Future Automation"},"best":{"price":15900,"label":"Invisible Surround","tag":"Best","features":["Invisible front, rear, and in-ceiling speakers","Coverage for Atmos and Surround","Dual in-wall invisible subwoofers","Atmos Surround Amplifier","Apple TV 4K source","Large behind TV box for local components"],"brands":"Sony AVR, Amina Loudspeakers, Apple TV 4K, Future Automation"}}},{"id":"theater","section":"Audio","name":"Home Theater / Media Room","icon":"üé¨","desc":"Dedicated entertainment experience ‚Äî from media room to reference theater (display not included)","sizeScale":0,"tiers":{"good":{"price":18000,"label":"Media Room","tag":"Good","features":["NO DISPLAY INCLUDED (see Video Wall)","5.2.2 Dolby Atmos surround","Combination of in-ceiling/in-wall speakers","Dual subwoofers (in-wall or in-room)","Atmos Surround Amplifier","Dimmable lighting scene (\"Movie Mode\")","Apple TV 4K source","Automation system control (app and remote)"],"brands":"Sonance, Sony AVR, Apple TV 4K, Lutron, Control4"},"standard":{"price":39000,"label":"Theater Quality","tag":"Standard","features":["NO DISPLAY INCLUDED (see Video Wall)","7.2.2 Dolby Atmos audio","Premium in-wall speakers & 2 subs","Dedicated AV receiver + amplification","Full light control","Automation system control (app and remote)","Kaleidescape movie server","Dedicated in-room equipment rack"],"brands":"Monitor Audio, Leon, Amina Loudspeakers, Sony AVR, Lutron, Control4, Crestron, Kaleidescape"},"better":{"price":88000,"label":"Reference Theater","tag":"Better","features":["NO DISPLAY INCLUDED (see Video Wall)","7.2.4 Dolby Atmos reference audio","Reference quality in-wall speakers & subs","Dedicated AV receiver","Dedicated multi-channel amplification","Full light control","Automation system control (app and remote)","Dedicated in-room equipment rack","Kaleidescape movie server","Full acoustic engineering"],"brands":"Monitor Audio, Leon, Amina Loudspeakers, Marantz, Sony, Lutron, Control4, Crestron, Kaleidescape, Triad, B&W"},"best":{"price":123000,"label":"Full Theater Experience","tag":"Best","features":["NO DISPLAY INCLUDED (see Video Wall)","7.2.4 Dolby Atmos reference audio","Reference quality in-wall speakers & subs","Dedicated AV receiver","Dedicated multi-channel amplification","Full light control","Automation system control (app and remote)","Dedicated in-room equipment rack","Kaleidescape movie server","Full acoustic engineering","$20,000 seating budget included","$15,000 acoustical paneling budget included"],"brands":"Monitor Audio, Leon, Amina Loudspeakers, Marantz, Sony, Lutron, Control4, Crestron, Kaleidescape, Triad, B&W"}}},{"id":"videodist","section":"Video","name":"TV Mounting & Video Distribution","icon":"üì∫","desc":"TV installations, mounting, and source distribution throughout the home","sizeScale":0.7,"tiers":{"good":{"price":5500,"label":"Local Sources, Basic","tag":"Good","features":["Main TVs mounted (fixed/tilt)","Apple TV at each location","In-wall HDMI & cable concealment"],"brands":"Strong Mounts, Apple TV 4K, in-wall HDMI"},"better":{"price":9200,"label":"Local Sources, Preferred","tag":"Better","features":["Main TVs mounted (Articulating)","Apple TV at each location","In-wall HDMI & cable concealment","Surge protection at each TV","Large back box behind TV to hold components and surge protector"],"brands":"Strong Mounts, Apple TV 4K, in-wall HDMI, WattBox"},"best":{"price":29000,"sizeScale":0.5,"label":"Video Over IP Distribution","tag":"Best","features":["Main TVs mounted (Articulating mounts)","Main TVs with video matrix switching","Any source on any TV","Perfect syncing of TV video for parties/events","Automation system control of Main TVs (remote and app)","Cable concealment","Surge protection at each TV","Large back box behind TV to hold components and surge protector"],"brands":"Control4, Crestron, Binary, Strong Mounts, Future Automation, Apple TV 4K, WattBox OvRC"}}},{"id":"control","section":"Control & Automation","name":"Control & Automation System","icon":"üéõÔ∏è","desc":"Unified control of all systems from touchscreens, remotes, and app","sizeScale":0.6,"tiers":{"good":{"price":9500,"label":"Automation Basic","tag":"Good","features":["Automation System Controller","Single Remote and App control of main TVs","Integration of installed components including lighting, music, and TVs","Basic scenes (Morning, Night, Movie)"],"brands":"Control4, Crestron"},"better":{"price":16000,"label":"Automation Enhanced","tag":"Better","features":["Advanced Automation System Controller","Single Remote and App control of main TVs","Upgraded premium remotes","Integration of installed, compatible components including lighting, shades, music, cameras, thermostats, gates, and TVs","Advanced scenes & scheduling"],"brands":"Control4, Crestron"},"best":{"price":29500,"label":"Full Automation","tag":"Best","features":["Advanced Automation System Controller","Single Remote and App control of all TVs","Upgraded premium remotes for main TVs","Full integration of any installed, compatible components including lighting, shades, music, security, cameras, thermostats, pool, gates, and TVs","Advanced scenes & scheduling"],"brands":"Control4, Crestron"}}},{"id":"touchscreen","section":"Control & Automation","name":"Touchscreens","icon":"üì±","desc":"The dedicated hub for instant home control‚Äîperfect for you and seamless for your guests","sizeScale":0,"tiers":{"good":{"price":2200,"label":"Touchscreen Essential","tag":"Good","features":["On-wall iPad mini in main living area"],"brands":"iPort, Apple"},"standard":{"price":4800,"label":"Touchscreen Basic","tag":"Standard","features":["On-wall iPads in main living area and master suite"],"brands":"iPort, Apple"},"better":{"price":7200,"label":"Touchscreen Standard","tag":"Better","features":["On-wall iPads in main living area and master suite","Desk mounted iPad mini for kitchen"],"brands":"iPort, Apple"},"best":{"price":23200,"sizeScale":0.5,"label":"Touchscreen Full","tag":"Best","features":["On-wall iPads or automation system touchscreens in all living areas, kitchen, guest suites (most if not all), and office/study","Desk mounted option where appropriate"],"brands":"iPort, Apple, Crestron, Control4"}}},{"id":"lighting","section":"Lighting & Shades","name":"Wireless Lighting Control","icon":"üí°","desc":"Smart lighting with scene control, dimming, and scheduling","sizeScale":1,"tiers":{"good":{"price":5500,"sizeScale":0.4,"label":"Wireless Basic","tag":"Good","features":["Wireless lighting control in main living areas and kitchen","App control from phone whether at home or away","Integration with control system (if selected)"],"brands":"Lutron Caseta"},"better":{"price":15000,"sizeScale":0.4,"label":"Wireless Partial","tag":"Better","features":["Wireless lighting control in main living areas, kitchen, and master suite","Scene keypads for each area and at entry(s). Push one button and lights automatically adjust","App control from phone whether at home or away","Integration with control system (if selected)"],"brands":"Lutron RadioRA, Control4 Contemporary, Crestron Cameo"},"best":{"price":32000,"sizeScale":0.9,"label":"Wireless Full Home","tag":"Best","features":["Wireless lighting control on every switch in the home","Scene keypads in every room","Comprehensive scenes (Wake, Entertain, Night, Away)","App control from phone whether at home or away"],"brands":"Lutron RadioRA, Control4 Contemporary, Crestron Cameo"}}},{"id":"lighting-centralized","section":"Lighting & Shades","name":"Centralized / Hybrid Lighting Control","icon":"üîÜ","desc":"Hardwired smart lighting control for max reliability and convenience including scene control, dimming, and scheduling","sizeScale":1,"tiers":{"good":{"price":30000,"sizeScale":0.4,"label":"Centralized Partial","tag":"Good","features":["Lighting control in main living areas, kitchen, and master suite","Clean look on wall, no banks of switches","Scene keypads in every room","Integration with control system (if selected)","App control from phone whether at home or away","Comprehensive scenes (Wake, Entertain, Night, Away)"],"brands":"Lutron HomeWorks, Control4 Centralized, Crestron Centralized"},"better":{"price":47000,"sizeScale":0.9,"label":"Hybrid Full Home","tag":"Better","features":["Combination of wireless and centralized lighting","Lighting control on every switch in the home","Main living areas, kitchen, and master suite are centralized","Other areas are wireless","Scene keypads in every room","Integration with control system (if selected)","App control from phone whether at home or away","Comprehensive scenes (Wake, Entertain, Night, Away)"],"brands":"Lutron RadioRA, Control4 Contemporary, Crestron Cameo, Lutron HomeWorks, Control4 Centralized, Crestron Centralized"},"best":{"price":60000,"sizeScale":0.9,"label":"Centralized Full Home","tag":"Best","features":["Centralized, hardwired lighting control of all lighting in the home","Clean look on wall, no banks of switches","Scene keypads in every room","Integration with control system (if selected)","App control from phone whether at home or away","Comprehensive scenes (Wake, Entertain, Night, Away)"],"brands":"Lutron HomeWorks, Control4 Centralized, Crestron Centralized"}}},{"id":"lighting-designer","section":"Lighting & Shades","name":"Designer Lighting Keypads","icon":"‚ú®","desc":"Elevate your lighting control with premium designer keypads featuring custom finishes and engraving","sizeScale":0,"tiers":{"good":{"price":6000,"sizeScale":0.4,"label":"Partial Home","tag":"Good","features":["Upgraded designer lighting keypads/switches in main living areas, kitchen, and master suite","Designer color/finish options","Custom engraving of keypad buttons"],"brands":"Lutron Sunnata (designer colors), Control4 Lux, Crestron Horizon, Lutron Palladiom"},"better":{"price":10000,"sizeScale":1,"label":"Full Home","tag":"Better","features":["Upgraded designer lighting keypads/switches throughout the home","Designer color/finish options","Custom engraving of keypad buttons"],"brands":"Lutron Sunnata (designer colors), Control4 Lux, Crestron Horizon, Lutron Palladiom"},"best":{"price":20000,"sizeScale":1,"label":"Full Home Bespoke","tag":"Best","features":["Upgraded bespoke lighting keypads/switches throughout the home","Designer color/finish options","Custom engraving of keypad buttons"],"brands":"Lutron Palladiom Glass/Metal, Lutron Alisse, Black Nova"}}},{"id":"shades","section":"Lighting & Shades","name":"Motorized Shades","icon":"ü™ü","desc":"Automated window treatments with scene integration","sizeScale":0.9,"tiers":{"good":{"price":35000,"sizeScale":0.4,"label":"Key Windows","tag":"Good","features":["Lutron motorized shades in single living area and master bedroom","Hardwired for max reliability","Light filtering or solar screen fabric","App and remote control","Integrated with control system (if selected)","Standard pockets"],"brands":"Lutron Sivoia, standard fabrics"},"better":{"price":70000,"sizeScale":0.8,"label":"Standard Windows","tag":"Better","features":["Lutron motorized shades in main living areas, master bedroom, and primary guest and/or master bath","Hardwired for max reliability","Mixture of light filtering, solar screen, and black out fabric","Mixture of in-wall keypads, app, and remote controls","Integrated with control system (if selected)","Standard pockets","Automated scenes (Morning, Movie, Entertaining)","Upgraded fabric selections"],"brands":"Lutron Sivoia, upgraded fabrics"},"best":{"price":100000,"label":"Most/All Windows","tag":"Best","features":["Lutron motorized shades on most, if not every window","Hardwired for max reliability","Mixture of light filtering, solar screen, and black out fabric","Possible drapery tracks on select windows","Mixture of in-wall keypads, app, and remote controls","Integrated with control system (if selected)","Standard pockets","Automated scenes (Morning, Movie, Entertaining)","Upgraded fabric selections"],"brands":"Lutron Sivoia, designer fabrics, Lutron drapery tracks"}}},{"id":"outdoor","section":"Audio","name":"Yard/Pool Audio","icon":"üå¥","desc":"Weather-rated outdoor audio and speakers","sizeScale":0.6,"tiers":{"good":{"price":6000,"sizeScale":0.2,"label":"Basic","tag":"Good","features":["Single outdoor zone with landscape style speakers","Weather-rated speakers","Integrated with whole-home audio","Basic coverage for entertaining"],"brands":"Sonos, Sonance Landscape"},"better":{"price":17000,"sizeScale":0.2,"label":"Preferred","tag":"Better","features":["Coastal Source speakers with sub","Premium outdoor audio coverage","Integrated with whole-home audio","IP68 rated for salt air"],"brands":"Coastal Source Razor, Coastal Source Linesource"},"best":{"price":24000,"sizeScale":0.4,"label":"Premium","tag":"Best","features":["Coastal Source premium system","Comprehensive speakers with dedicated subs","Independently controlled zones (where appropriate)","Full yard coverage","Premium amplification","Integrated with whole-home audio","IP68 rated for salt air"],"brands":"Coastal Source Ellipse/Line Source, Coastal Source Razor"}}},{"id":"security","section":"Security","name":"Security & Alarm System","icon":"üîí","desc":"Intrusion detection, sensors, and 24/7 monitoring","sizeScale":0.6,"tiers":{"good":{"price":3500,"sizeScale":0.5,"label":"Essential Protection","tag":"Good","features":["Coverage of all exterior doors","Motion detectors","Keypad at garage entry","Supports 24/7 professional monitoring","App control via Alarm.com"],"brands":"DSC Neo, Alarm.com"},"better":{"price":7500,"sizeScale":0.8,"label":"Standard Security","tag":"Better","features":["Coverage of all exterior windows and doors","Motion detectors","Keypads at garage entry(s) and master bedroom","Supports 24/7 professional monitoring","App control via Alarm.com"],"brands":"DSC Neo, Alarm.com"},"best":{"price":9500,"sizeScale":0.8,"label":"Full Integration","tag":"Best","features":["Commercial-grade panel + full sensor coverage","Multi method motion detectors","Keypads at garage entry(s), safe room (if appropriate), and master bedroom","Supports 24/7 professional monitoring","App control via Alarm.com","Full Crestron/Control4 integration","Panic buttons on keypads"],"brands":"DSC PowerSeries Neo / Qolsys, Alarm.com"}}},{"id":"intercom","section":"Security","name":"Intercom, Doorbell & Access Control","icon":"üö™","desc":"Video doorbell, gate intercom, and entry access management","sizeScale":0.2,"tiers":{"good":{"price":2000,"label":"Video Doorbell","tag":"Good","features":["Hardwired video doorbell (PoE)","2-way audio & video at front door","App notifications when someone rings"],"brands":"UniFi, Control4"},"better":{"price":7500,"label":"Video Doorbell + Gate","tag":"Better","features":["Hardwired video doorbell (PoE)","2-way audio & video at front door","App notifications when someone rings","Gate video intercom with keypad","Integration with automatic gate for opening and closing","Remote gate open from phone"],"brands":"UniFi, Control4"},"best":{"price":10500,"label":"Premium Video Doorbell and Gate","tag":"Best","features":["Premium hardwired doorbell station (PoE)","2-way audio & video at front door","App notifications when someone rings","Gate video intercom with keypad","Integration with automatic gate for opening and closing","Remote gate open from phone","Multi-tenant/guest access codes","Full Crestron/Control4 integration"],"brands":"UniFi, Control4, 2N"}}},{"id":"videowall-interior","section":"Video","name":"Video Wall Interior","icon":"üñ•Ô∏è","desc":"Large-format LED video wall installations for indoor spaces","sizeScale":0,"tiers":{"good":{"price":50000,"label":"136\" Display Standard","tag":"Good","features":["High density pixels for clear picture (1.2pp)","Supports up to 3 video signals at the same time","3 4K Apple TVs","Professional calibration and installation","Integration with Control4 or Crestron"],"brands":"Opal Screens Crystal Series"},"standard":{"price":69000,"label":"136\" Display Premium","tag":"Standard","features":["Super high density pixels for clearest picture (.9pp)","Supports up to 4 video signals at the same time","BlackFire technology for the deepest blacks","4 4K Apple TVs","Professional calibration and installation","Integration with Control4 or Crestron","Ambient art mode with customer provided art"],"brands":"Opal Screens Crystal Series"},"better":{"price":89000,"label":"163\" Display Premium","tag":"Better","features":["Super high density pixels for clearest picture (.9pp)","Supports up to 4 video signals at the same time","BlackFire technology for the deepest blacks","4 4K Apple TVs","Professional calibration and installation","Integration with Control4 or Crestron","Ambient art mode with customer provided art"],"brands":"Opal Screens Crystal Series"},"best":{"price":119000,"label":"190\" Display Premium","tag":"Best","features":["Super high density pixels for clearest picture (.9pp)","Supports up to 4 video signals at the same time","BlackFire technology for the deepest blacks","4 4K Apple TVs","Professional calibration and installation","Integration with Control4 or Crestron","Ambient art mode with customer provided art"],"brands":"Opal Screens Crystal Series"}}},{"id":"videowall-exterior","section":"Video","name":"Video Wall Exterior","icon":"‚òÄÔ∏è","desc":"Weather-rated outdoor LED video wall installations","sizeScale":0,"tiers":{"good":{"price":83000,"label":"136\" Outdoor Display Standard","tag":"Good","features":["Outdoor weather rated for direct exposure to the weather","8X brighter than indoor models for direct sun viewing","High density pixels for clear picture (1.5pp)","Supports up to 3 video signals at the same time","3 4K Apple TVs","Professional calibration and installation","Integration with Control4 or Crestron"],"brands":"Opal Screens Water Series"},"standard":{"price":109000,"label":"136\" Outdoor Display Premium","tag":"Standard","features":["Outdoor weather rated for direct exposure to the weather","8X brighter than indoor models for direct sun viewing","Super high density pixels for clearest picture (1.2pp)","Supports up to 4 video signals at the same time","BlackFire technology for the deepest blacks","4 4K Apple TVs","Professional calibration and installation","Integration with Control4 or Crestron","Ambient art mode with customer provided art"],"brands":"Opal Screens Water Series"},"better":{"price":149000,"label":"163\" Outdoor Display Premium","tag":"Better","features":["Outdoor weather rated for direct exposure to the weather","8X brighter than indoor models for direct sun viewing","Super high density pixels for clearest picture (1.2pp)","Supports up to 4 video signals at the same time","BlackFire technology for the deepest blacks","4 4K Apple TVs","Professional calibration and installation","Integration with Control4 or Crestron","Ambient art mode with customer provided art"],"brands":"Opal Screens Water Series"},"best":{"price":179000,"label":"190\" Outdoor Display Premium","tag":"Best","features":["Outdoor weather rated for direct exposure to the weather","8X brighter than indoor models for direct sun viewing","Super high density pixels for clearest picture (1.2pp)","Supports up to 4 video signals at the same time","BlackFire technology for the deepest blacks","4 4K Apple TVs","Professional calibration and installation","Integration with Control4 or Crestron","Ambient art mode with customer provided art"],"brands":"Opal Screens Water Series"}}}];

function getDefaultCategories(propertyType) {
  // Returns full category data including sizeScale for accurate price calculation
  return ADMIN_CATEGORIES;
}

// ============================================================
// USERS
// ============================================================
let users = [];

async function loadUsers() {
  try {
    const res = await fetch(api('/api/admin/users'), { credentials: 'include' });
    if (res.status === 401) {
      showLogin();
      return;
    }
    users = await res.json();
    renderUsers();
  } catch (err) {
    console.error('Load users error:', err);
    showToast('Failed to load users');
  }
}

function renderUsers() {
  const tbody = document.getElementById('usersTableBody');
  
  if (users.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="empty-state">No users</td></tr>`;
    return;
  }
  
  tbody.innerHTML = users.map(u => `
    <tr>
      <td><strong>${u.username}</strong></td>
      <td>${u.name}</td>
      <td>${formatDate(u.created)}</td>
      <td class="actions-cell">
        <button class="btn btn-secondary btn-small" onclick="editUser('${u.id}')">Edit</button>
        ${u.id !== currentUser.id ? `<button class="btn btn-small" style="background:#FFF3E0;color:#E65100;" onclick="deleteUser('${u.id}')">Delete</button>` : '<span style="color:var(--text-light);font-size:12px;">(you)</span>'}
      </td>
    </tr>
  `).join('');
}

function showUserModal(userId = null) {
  const isEdit = !!userId;
  document.getElementById('userModalTitle').textContent = isEdit ? 'Edit User' : 'Add User';
  document.getElementById('userEditId').value = userId || '';
  document.getElementById('passwordHint').style.display = isEdit ? 'block' : 'none';
  document.getElementById('userPassword').required = !isEdit;
  
  if (isEdit) {
    const user = users.find(u => u.id === userId);
    if (user) {
      document.getElementById('userUsername').value = user.username;
      document.getElementById('userName').value = user.name;
      document.getElementById('userPassword').value = '';
    }
  } else {
    document.getElementById('userUsername').value = '';
    document.getElementById('userName').value = '';
    document.getElementById('userPassword').value = '';
  }
  
  document.getElementById('userModal').classList.add('active');
  document.getElementById('userUsername').focus();
}

function closeUserModal() {
  document.getElementById('userModal').classList.remove('active');
}

function editUser(id) {
  showUserModal(id);
}

async function handleUserSubmit(e) {
  e.preventDefault();
  
  const editId = document.getElementById('userEditId').value;
  const username = document.getElementById('userUsername').value.trim();
  const name = document.getElementById('userName').value.trim();
  const password = document.getElementById('userPassword').value;
  
  const isEdit = !!editId;
  
  const body = { email: username, name };
  if (password) body.password = password;
  
  try {
    const url = api(isEdit ? `/api/admin/users/${editId}` : '/api/auth/users');
    const method = isEdit ? 'PUT' : 'POST';
    
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      showToast(isEdit ? '‚úì User updated' : '‚úì User created');
      closeUserModal();
      loadUsers();
    } else {
      showToast('‚ùå ' + (data.error || 'Failed to save user'));
    }
  } catch (err) {
    console.error('Save user error:', err);
    showToast('Failed to save user');
  }
}

async function deleteUser(id) {
  const user = users.find(u => u.id === id);
  if (!user) return;
  
  if (!confirm(`Delete user "${user.username}"? This cannot be undone.`)) return;
  
  try {
    const res = await fetch(api(`/api/admin/users/${id}`), { method: 'DELETE' });
    const data = await res.json();
    
    if (res.ok && data.success) {
      showToast('‚úì User deleted');
      loadUsers();
    } else {
      showToast('‚ùå ' + (data.error || 'Failed to delete user'));
    }
  } catch (err) {
    console.error('Delete user error:', err);
    showToast('Failed to delete user');
  }
}

// ============================================================
// UTILITIES
// ============================================================
function formatCurrency(num) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(num || 0);
}

function formatDate(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso);
  if (isNaN(d.getTime())) return '‚Äî';
  return d.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
}

function formatDateTime(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso);
  if (isNaN(d.getTime())) return '‚Äî';
  return d.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit'
  });
}

function formatRelative(iso) {
  const date = new Date(iso);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return formatDate(iso);
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 3000);
}

// Close modal on escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    closeUserModal();
    closeNewBudgetModal();
    closeCustomizeModal();
    closeFeaturesModal();
  }
});

// Close modal on backdrop click
document.getElementById('budgetModal').addEventListener('click', (e) => {
  if (e.target.id === 'budgetModal') closeModal();
});

document.getElementById('userModal').addEventListener('click', (e) => {
  if (e.target.id === 'userModal') closeUserModal();
});

document.getElementById('newBudgetModal').addEventListener('click', (e) => {
  if (e.target.id === 'newBudgetModal') closeNewBudgetModal();
});

document.getElementById('customizeModal').addEventListener('click', (e) => {
  if (e.target.id === 'customizeModal') closeCustomizeModal();
});

document.getElementById('featuresModal').addEventListener('click', (e) => {
  if (e.target.id === 'featuresModal') closeFeaturesModal();
});

// Initialize
init();
</script>
</body>
</html>
